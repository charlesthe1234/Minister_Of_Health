@page "/calendarevents/edit/{Id:int}"
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Edit Event</PageTitle>

<div class="container mt-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white p-4">
            <h3 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Edit Event Details</h3>
        </div>

        <div class="card-body p-4">
            @if (CalendarEvent is null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading event data...</p>
                </div>
            }
            else
            {
                <EditForm Model="CalendarEvent" OnValidSubmit="UpdateCalendarEvent">
                    <DataAnnotationsValidator />

                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Event Name</label>
                            <InputText @bind-Value="CalendarEvent.EventName" class="form-control form-control-lg" placeholder="e.g., Strategy Meeting" />
                            <ValidationMessage For="() => CalendarEvent.EventName" class="text-danger" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Start Date & Time</label>
                            <input type="datetime-local" class="form-control"
                                   value="@CalendarEvent.StartDateTime.ToString("yyyy-MM-ddTHH:mm")"
                                   @onchange='(e) => CalendarEvent.StartDateTime = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())' />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">End Date & Time</label>
                            <input type="datetime-local" class="form-control"
                                   value="@CalendarEvent.EndDateTime.ToString("yyyy-MM-ddTHH:mm")"
                                   @onchange='(e) => CalendarEvent.EndDateTime = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())' />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Location</label>
                            <InputText @bind-Value="CalendarEvent.Location" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Category</label>
                            <InputSelect @bind-Value="CalendarEvent.CalendarType" class="form-select">
                                <option value="Work">Work</option>
                                <option value="Personal">Personal</option>
                                <option value="Holiday">Holiday</option>
                            </InputSelect>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Description</label>
                            <InputTextArea @bind-Value="CalendarEvent.Description" class="form-control" rows="3" />
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                        <button type="button" class="btn btn-outline-danger" @onclick="DeleteEvent">
                            <i class="bi bi-trash"></i> Delete Event
                        </button>

                        <div class="d-flex gap-2">
                            <a href="/calendarevents" class="btn btn-light border">Cancel</a>
                            <button type="submit" class="btn btn-primary px-5 fw-bold">Save Changes</button>
                        </div>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private CalendarEvent? CalendarEvent { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        // Fetch event AND check if user has permission (Host or Admin)
        var ev = await context.CalendarEvent.FindAsync(Id);

        if (ev == null)
        {
            NavigationManager.NavigateTo("/calendarevents");
            return;
        }

        // Verify user is Host OR an Admin participant
        var isAdmin = await context.EventParticipant
            .Include(p => p.EventRole)
            .AnyAsync(p => p.CalendarEventId == Id && p.UserId == userId && p.EventRole.RoleName == "Admin");

        if (ev.HostUserId != userId && !isAdmin)
        {
            NavigationManager.NavigateTo("/calendarevents?error=Unauthorized");
            return;
        }

        CalendarEvent = ev;
    }

    private async Task UpdateCalendarEvent()
    {
        if (CalendarEvent == null) return;

        using var context = DbFactory.CreateDbContext();
        CalendarEvent.DateUpdated = DateTime.Now;
        context.Attach(CalendarEvent).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo("/calendarevents?success=true");
        }
        catch (DbUpdateConcurrencyException)
        {
            NavigationManager.NavigateTo("/calendarevents?error=Concurrency");
        }
    }

    private async Task DeleteEvent()
    {
        if (CalendarEvent == null) return;

        using var context = DbFactory.CreateDbContext();
        context.CalendarEvent.Remove(CalendarEvent);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/calendarevents");
    }
}