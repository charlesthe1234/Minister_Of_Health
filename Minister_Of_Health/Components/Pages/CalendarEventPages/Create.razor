@page "/calendarevents/create"
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations

@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <h2 class="mb-4">Schedule New Event</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger shadow-sm">@errorMessage</div>
        }

        <EditForm Model="Input" OnValidSubmit="AddCalendarEvent" FormName="createEventForm">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Event Name</label>
                    <InputText @bind-Value="Input.EventName" class="form-control" placeholder="What's happening?" />
                    <ValidationMessage For="() => Input.EventName" class="text-danger" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Location</label>
                    <InputText @bind-Value="Input.Location" class="form-control" placeholder="Physical or Digital address" />
                    <ValidationMessage For="() => Input.Location" class="text-danger" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Start Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal"
                               @bind-Value="Input.StartDateTime"
                               @bind-Value:after="SyncDates"
                               class="form-control" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">End Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="Input.EndDateTime" class="form-control" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Activity Type</label>
                    @* CHANGED: Use InputText instead of <input> so validation triggers correctly *@
                    <InputText list="activity-suggestions"
                               @bind-Value="Input.ActivityName"
                               class="form-control"
                               placeholder="e.g., Training" />

                    <datalist id="activity-suggestions">
                        @foreach (var suggestion in Suggestions)
                        {
                            <option value="@suggestion.Name" />
                        }
                    </datalist>
                    <ValidationMessage For="() => Input.ActivityName" class="text-danger" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Category</label>
                <InputSelect @bind-Value="Input.CalendarType" class="form-select">
                    <option value="Work">Work</option>
                    <option value="Life">Life</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Invite Users (Emails)</label>
                <InputTextArea @bind-Value="Input.InvitedEmails" class="form-control" rows="2" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <InputTextArea @bind-Value="Input.Description" class="form-control" rows="3" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                @* CHANGED: Using a standard link (<a>) styled as a button for navigation *@
                <a href="/calendarevents" class="btn btn-light border">Cancel</a>

                <button type="submit" class="btn btn-primary px-4">Create Event</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private string? errorMessage;
    private List<UserActivity> Suggestions = new();

    [SupplyParameterFromForm]
    private EventInputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Default values for new form
        if (Input.StartDateTime == default)
        {
            Input.StartDateTime = DateTime.Now;
            Input.EndDateTime = DateTime.Now.AddHours(1);
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userIdStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (int.TryParse(userIdStr, out int currentUserId))
        {
            using var context = DbFactory.CreateDbContext();
            Suggestions = await context.UserActivity
                .Where(a => a.UserId == currentUserId)
                .ToListAsync();
        }
    }

    private void SyncDates()
    {
        if (Input.StartDateTime >= Input.EndDateTime)
        {
            Input.EndDateTime = Input.StartDateTime.AddHours(1);
            StateHasChanged();  // This tells Blazor to refresh the UI immediately
        }
    }

    private async Task AddCalendarEvent()
    {
        errorMessage = "";

        // Final Logic Validation
        if (Input.EndDateTime <= Input.StartDateTime)
        {
            errorMessage = "Error: Start date must be before the end date.";
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            int currentUserId = int.Parse(user.FindFirst(ClaimTypes.NameIdentifier)!.Value);

            // 1. Find or Create Activity
            var actName = string.IsNullOrWhiteSpace(Input.ActivityName) ? "General" : Input.ActivityName.Trim();
            var activity = await context.UserActivity
                .FirstOrDefaultAsync(a => a.Name.ToLower() == actName.ToLower() && a.UserId == currentUserId);

            if (activity == null)
            {
                activity = new UserActivity { Name = actName, UserId = currentUserId };
                context.UserActivity.Add(activity);
                await context.SaveChangesAsync();
            }

            // 2. Map Input to Domain Model
            var newEvent = new CalendarEvent
            {
                EventName = Input.EventName,
                Location = Input.Location,
                StartDateTime = Input.StartDateTime,
                EndDateTime = Input.EndDateTime,
                CalendarType = Input.CalendarType,
                HostUserId = currentUserId,
                UserActivityId = activity.Id,
                CreatedBy = user.Identity.Name,
                DateCreated = DateTime.Now,
                Description = Input.Description // Make sure this property exists in your domain model
            };

            context.CalendarEvent.Add(newEvent);
            await context.SaveChangesAsync();

            // 3. Invitations... (Existing logic omitted for brevity, use Input.InvitedEmails)

            NavigationManager.NavigateTo("/calendarevents");
        }
    }

    private sealed class EventInputModel
    {
        [Required(ErrorMessage = "Some of the required fields are empty")]
        public string EventName { get; set; } = "";

        [Required(ErrorMessage = "Some of the required fields are empty")]
        public string Location { get; set; } = "";

        [Required(ErrorMessage = "Some of the required fields are empty")]
        public string ActivityName { get; set; } = "General";

        public DateTime StartDateTime { get; set; }
        public DateTime EndDateTime { get; set; }
        public string CalendarType { get; set; } = "Work";
        public string InvitedEmails { get; set; } = "";
        public string Description { get; set; } = "";
    }
}