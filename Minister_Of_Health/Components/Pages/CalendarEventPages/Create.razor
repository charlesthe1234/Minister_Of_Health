@page "/calendarevents/create"
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <h2 class="mb-4">Schedule New Event</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger shadow-sm">@errorMessage</div>
        }

        <EditForm Model="Input" OnValidSubmit="AddCalendarEvent" FormName="createEventForm">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Event Name</label>
                    <InputText @bind-Value="Input.EventName" class="form-control" placeholder="What's happening?" />
                    <ValidationMessage For="() => Input.EventName" class="text-danger" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Location</label>
                    <InputText @bind-Value="Input.Location" class="form-control" placeholder="Physical or Digital address" />
                    <ValidationMessage For="() => Input.Location" class="text-danger" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Start Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal"
                               @bind-Value="Input.StartDateTime"
                               @bind-Value:after="SyncDates"
                               step="60"
                               class="form-control" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">End Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal"
                               @bind-Value="Input.EndDateTime"
                               step="60"
                               class="form-control" />
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Activity Name</label>
                <InputSelect @bind-Value="Input.UserActivityId" class="form-select">
                    <option value="">-- Select an Activity --</option>
                    @foreach (var activity in Suggestions)
                    {
                        <option value="@activity.Id.ToString()">@activity.Name (@activity.ActivityType)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Input.UserActivityId" class="text-danger" />
            </div>

            <a href="/useractivities/create" class="btn btn-primary">
                New Activity
            </a>

            <div class="mb-3">
                <label class="form-label fw-bold">Invite Users (Emails)</label>
                <InputTextArea @bind-Value="Input.InvitedEmails" class="form-control" rows="2" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <InputTextArea @bind-Value="Input.Description" class="form-control" rows="3" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <a href="/calendarevents" class="btn btn-light border">Cancel</a>
                <button type="submit" class="btn btn-primary px-4">Create Event</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private string? errorMessage;
    private List<UserActivity> Suggestions = new();

    private List<(string Email, string RoleName)> ParseInvites(string input)
    {
        var list = new List<(string, string)>();
        if (string.IsNullOrWhiteSpace(input)) return list;

        var parts = input.Split(',');
        foreach (var p in parts)
        {
            var trimmed = p.Trim();
            var match = System.Text.RegularExpressions.Regex.Match(trimmed, @"^([^(\s]+)(?:\((.+?)\))?$");

            if (match.Success)
                list.Add((match.Groups[1].Value.Trim(), match.Groups[2].Value.Trim()));
            else
                list.Add((trimmed, "Viewer"));
        }
        return list;
    }

    [SupplyParameterFromForm]
    private EventInputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        var now = DateTime.Now;
        var cleanNow = new DateTime(now.Year, now.Month, now.Day, now.Hour, now.Minute, 0);

        if (Input.StartDateTime == default)
        {
            Input.StartDateTime = cleanNow;
            Input.EndDateTime = cleanNow.AddHours(1);
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userIdStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        // Corrected to use string comparison
        if (!string.IsNullOrEmpty(userIdStr))
        {
            using var context = DbFactory.CreateDbContext();
            Suggestions = await context.UserActivity
                .Where(a => a.UserId == userIdStr)
                .ToListAsync();
        }
    }

    private void SyncDates()
    {
        Input.StartDateTime = new DateTime(
            Input.StartDateTime.Year, Input.StartDateTime.Month, Input.StartDateTime.Day,
            Input.StartDateTime.Hour, Input.StartDateTime.Minute, 0);

        if (Input.StartDateTime >= Input.EndDateTime)
        {
            Input.EndDateTime = Input.StartDateTime.AddHours(1);
            StateHasChanged();
        }
    }

    private async Task AddCalendarEvent()
    {
        errorMessage = "";

        if (Input.EndDateTime <= Input.StartDateTime)
        {
            errorMessage = "Error: Start date must be before the end date.";
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();

            // Corrected: Removed int.Parse and handled as string
            string currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";

            if (Input.UserActivityId == 0)
            {
                errorMessage = "Please select a valid activity.";
                return;
            }

            var newEvent = new CalendarEvent
            {
                EventName = Input.EventName,
                Location = Input.Location,
                StartDateTime = Input.StartDateTime,
                EndDateTime = Input.EndDateTime,
                CalendarType = Input.CalendarType,
                HostUserId = currentUserId,
                UserActivityId = Input.UserActivityId,
                CreatedBy = user.Identity.Name,
                DateCreated = DateTime.Now,
                Description = Input.Description
            };

            context.CalendarEvent.Add(newEvent);

            var inviteDetails = ParseInvites(Input.InvitedEmails);

            if (inviteDetails.Any())
            {
                var roles = await context.EventRole.ToDictionaryAsync(r => r.RoleName.ToLower(), r => r.Id);

                foreach (var item in inviteDetails)
                {
                    roles.TryGetValue(item.RoleName.ToLower(), out int roleId);
                    if (roleId == 0) roleId = 2;

                    context.EventParticipant.Add(new EventParticipant
                    {
                        CalendarEvent = newEvent,
                        InviteeEmail = item.Email,
                        EventRoleId = roleId,
                        ParticipationStatus = "Pending"
                    });
                }
            }

            await context.SaveChangesAsync();
            NavigationManager.NavigateTo("/calendarevents");
        }
    }

    private sealed class EventInputModel
    {
        [Required(ErrorMessage = "Some of the required fields are empty")]
        public string EventName { get; set; } = "";

        [Required(ErrorMessage = "Some of the required fields are empty")]
        public string Location { get; set; } = "";

        [Required(ErrorMessage = "Please select an activity")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select an activity")]
        public int UserActivityId { get; set; } // Changed from ActivityName string to int ID

        public DateTime StartDateTime { get; set; }
        public DateTime EndDateTime { get; set; }
        public string CalendarType { get; set; } = "Work";
        public string InvitedEmails { get; set; } = "";
        public string Description { get; set; } = "";
    }
}