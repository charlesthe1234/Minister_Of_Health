@page "/calendarevents/create"
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <h2 class="mb-4">Schedule New Event</h2>

        <EditForm Model="CalendarEvent" OnValidSubmit="AddCalendarEvent" FormName="create">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Event Name</label>
                    <InputText @bind-Value="CalendarEvent.EventName" class="form-control" placeholder="What's happening?" />
                </div>
                <div class="col-md6 mb-3">
                    <label class="form-label fw-bold">Location</label>
                    <InputText @bind-Value="CalendarEvent.Location" class="form-control" placeholder="Physical or Digital address" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Start Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="CalendarEvent.StartDateTime" @bind-Value:after="SyncDates"  class="form-control" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">End Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="CalendarEvent.EndDateTime" class="form-control" />
                </div>
                
                @* UPDATED: Using the Activity Name as the "Key" for the UserActivity table *@
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Activity Type</label>
                    <input list="activity-suggestions" @bind="InputActivityName" class="form-control" placeholder="e.g., Training, Meeting" />
                    <datalist id="activity-suggestions">
                        @foreach (var suggestion in Suggestions)
                        {
                            <option value="@suggestion.Name" />
                        }
                    </datalist>
                </div>
            </div>

            @* Keep your Category for color/sorting purposes if you like *@
            <div class="mb-3">
                <label class="form-label fw-bold">Category (Color Grouping)</label>
                <InputSelect @bind-Value="CalendarEvent.CalendarType" class="form-select">
                    <option value="Work">Work</option>
                    <option value="Life">Life</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Invite Users (Comma separated emails)</label>
                <InputTextArea @bind-Value="InvitedEmails" class="form-control" placeholder="user1@example.com, user2@example.com" rows="2" />
                <small class="text-muted">Separate multiple emails with a comma.</small>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <InputTextArea @bind-Value="EventDescription" class="form-control" rows="3" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-light" @onclick='() => NavigationManager.NavigateTo("/calendarevents")'>Cancel</button>
                <button type="submit" class="btn btn-primary px-4">Create Event</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public CalendarEvent CalendarEvent { get; set; } = new() 
    { 
        StartDateTime = DateTime.Now, 
        EndDateTime = DateTime.Now.AddHours(1), 
        CalendarType = "Work" 
    };

    [SupplyParameterFromForm]
    public string InvitedEmails { get; set; } = "";

    [SupplyParameterFromForm]
    public string EventDescription { get; set; } = "";

    [SupplyParameterFromForm]
    public string InputActivityName { get; set; } = "General";

    private List<UserActivity> Suggestions = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userIdStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (int.TryParse(userIdStr, out int currentUserId))
        {
            using var context = DbFactory.CreateDbContext();
            // Load existing activities so the user can select them from the list
            Suggestions = await context.UserActivity
                .Where(a => a.UserId == currentUserId)
                .ToListAsync();
        }
    }

    private async Task AddCalendarEvent()
    {
        // 1. Validation Check to ensure end date is not before start date
        if (CalendarEvent.EndDateTime < CalendarEvent.StartDateTime)
        {
            // Force them to be equal if the user tried to cheat
            CalendarEvent.EndDateTime = CalendarEvent.StartDateTime;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            int currentUserId = int.Parse(user.FindFirst(ClaimTypes.NameIdentifier)!.Value);

            // 1. FIND OR CREATE ACTIVITY
            var activityName = string.IsNullOrWhiteSpace(InputActivityName) ? "General" : InputActivityName.Trim();
            
            var activity = await context.UserActivity
                .FirstOrDefaultAsync(a => a.Name.ToLower() == activityName.ToLower() && a.UserId == currentUserId);

            if (activity == null)
            {
                activity = new UserActivity { Name = activityName, UserId = currentUserId };
                context.UserActivity.Add(activity);
                await context.SaveChangesAsync(); // Generates the new ID
            }

            // 2. ASSIGN FOREIGN KEYS & AUDIT INFO
            CalendarEvent.HostUserId = currentUserId;
            CalendarEvent.UserActivityId = activity.Id; // The actual ID for the DB constraint
            CalendarEvent.CreatedBy = user.Identity.Name;
            CalendarEvent.DateCreated = DateTime.Now;

            context.CalendarEvent.Add(CalendarEvent);
            await context.SaveChangesAsync();

            // 3. HANDLE INVITATIONS (Your existing logic)
            if (!string.IsNullOrWhiteSpace(InvitedEmails))
            {
                var emails = InvitedEmails.Split(',').Select(e => e.Trim()).ToList();
                foreach (var email in emails)
                {
                    var invitedUser = await context.User.FirstOrDefaultAsync(u => u.Email == email);
                    if (invitedUser != null)
                    {
                        context.EventParticipant.Add(new EventParticipant
                        {
                            CalendarEventId = CalendarEvent.Id,
                            UserId = invitedUser.Id,
                            ParticipationStatus = "Pending"
                        });
                    }
                }
                await context.SaveChangesAsync();
            }

            NavigationManager.NavigateTo("/calendarevents");
        }
    }

    // Method added to ensure end date is not before start date
    private void SyncDates()
    {
        // If the start date is now AFTER the end date, move the end date forward
        if (CalendarEvent.StartDateTime > CalendarEvent.EndDateTime)
        {
            // Set end date to 1 hour after start date by default
            CalendarEvent.EndDateTime = CalendarEvent.StartDateTime.AddHours(1);
        }
    }
}