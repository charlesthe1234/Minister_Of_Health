@page "/calendarevents/create"
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <h2 class="mb-4">Schedule New Event</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger shadow-sm">
                <i class="bi bi-exclamation-octagon-fill me-2"></i> @errorMessage
            </div>
        }

        <EditForm Model="Input" OnValidSubmit="AddCalendarEvent" FormName="createEventForm">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Event Name</label>
                    <InputText @bind-Value="Input.EventName" class="form-control" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Location</label>
                    <InputText @bind-Value="Input.Location" class="form-control" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Start Date & Time</label>
                    <input type="datetime-local" class="form-control"
                           value="@Input.StartDateTime.ToString("yyyy-MM-ddTHH:mm")"
                           @onchange="OnStartDateChanged" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">End Date & Time</label>
                    <input type="datetime-local" class="form-control"
                           value="@Input.EndDateTime.ToString("yyyy-MM-ddTHH:mm")"
                           @onchange="OnEndDateChanged" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Activity Type</label>
                    <InputText list="activity-suggestions" @bind-Value="Input.ActivityName" class="form-control" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold d-block">Invite Users</label>

                <div class="mb-2 p-2 border rounded bg-light" style="min-height: 40px; font-size: 0.9rem;">
                    <span class="fw-bold me-2">Verification Status:</span>
                    @if (!inviteStatusList.Any())
                    {
                        <span class="text-muted italic">No emails entered yet...</span>
                    }
                    @foreach (var status in inviteStatusList)
                    {
                        @if (status.IsDuplicate)
                        {
                            <span class="badge bg-danger me-1" title="Duplicate or Host Email">
                                @status.Email <i class="bi bi-exclamation-triangle"></i> !
                            </span>
                        }
                        else
                        {
                            <span class="badge @(status.IsRegistered ? "bg-success" : "bg-warning text-dark") me-1">
                                @status.Email @(status.IsRegistered ? "✓" : "?")
                            </span>
                        }
                    }
                </div>

                <InputTextArea @bind-Value="Input.InvitedEmails"
                               @oninput="OnInviteInputChanged"
                               class="form-control" rows="2"
                               placeholder="user@example.com, unknown@example.com (Editor)" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <InputTextArea @bind-Value="Input.Description" class="form-control" rows="3" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <a href="/calendarevents" class="btn btn-light border">Cancel</a>
                <button type="submit" class="btn btn-primary px-4" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Create Event
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? Date { get; set; }
    private string? errorMessage;
    private bool isSubmitting = false;
    private List<UserActivity> Suggestions = new();
    private List<EmailStatus> inviteStatusList = new();

    private class EmailStatus
    {
        public string Email { get; set; } = "";
        public bool IsRegistered { get; set; }
        public bool IsDuplicate { get; set; }
    }

    [SupplyParameterFromForm] private EventInputModel Input { get; set; } = new();

    private void OnStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var newDate))
        {
            Input.StartDateTime = newDate;
            if (Input.StartDateTime >= Input.EndDateTime) Input.EndDateTime = Input.StartDateTime.AddHours(1);
            StateHasChanged();
        }
    }

    private void OnEndDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var newDate))
        {
            Input.EndDateTime = newDate;
            if (Input.EndDateTime <= Input.StartDateTime) Input.StartDateTime = Input.EndDateTime.AddHours(-1);
            StateHasChanged();
        }
    }

    private async Task OnInviteInputChanged(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        Input.InvitedEmails = input;
        var parsed = ParseInvites(input);
        var newList = new List<EmailStatus>();
        var seenEmails = new HashSet<string>();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.FindFirst(ClaimTypes.Email)?.Value?.ToLower();

        using var context = DbFactory.CreateDbContext();
        foreach (var item in parsed)
        {
            var emailLower = item.Email.ToLower();

            // Flag as duplicate if seen before OR if it is the host's own email
            bool isSelf = emailLower == currentUserEmail;
            bool duplicate = seenEmails.Contains(emailLower) || isSelf;
            seenEmails.Add(emailLower);

            var exists = await context.Users.AnyAsync(u => u.Email.ToLower() == emailLower);
            newList.Add(new EmailStatus { Email = item.Email, IsRegistered = exists, IsDuplicate = duplicate });
        }
        inviteStatusList = newList;

        if (!inviteStatusList.Any(x => x.IsDuplicate)) errorMessage = null;
        StateHasChanged();
    }

    private List<(string Email, string RoleName)> ParseInvites(string input)
    {
        var list = new List<(string, string)>();
        if (string.IsNullOrWhiteSpace(input)) return list;
        foreach (var p in input.Split(','))
        {
            var trimmed = p.Trim();
            if (string.IsNullOrEmpty(trimmed)) continue;
            var match = System.Text.RegularExpressions.Regex.Match(trimmed, @"^([^(\s]+)(?:\((.+?)\))?$");
            if (match.Success) list.Add((match.Groups[1].Value.Trim(), match.Groups[2].Value.Trim()));
            else list.Add((trimmed, "Viewer"));
        }
        return list;
    }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Date) && DateTime.TryParse(Date, out var passedDate))
        {
            var now = DateTime.Now;
            Input.StartDateTime = new DateTime(passedDate.Year, passedDate.Month, passedDate.Day, now.Hour, 0, 0);
            Input.EndDateTime = Input.StartDateTime.AddHours(1);
        }
        else if (Input.StartDateTime == default)
        {
            var now = DateTime.Now;
            Input.StartDateTime = new DateTime(now.Year, now.Month, now.Day, now.Hour, now.Minute, 0);
            Input.EndDateTime = Input.StartDateTime.AddHours(1);
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdStr = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userIdStr))
        {
            using var context = DbFactory.CreateDbContext();
            Suggestions = await context.UserActivity.Where(a => a.UserId == userIdStr).ToListAsync();
        }
    }

    private async Task AddCalendarEvent()
    {
        if (inviteStatusList.Any(x => x.IsDuplicate))
        {
            errorMessage = "Please remove duplicates or your own email from the invite list.";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        using var context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        string currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";

        var actName = string.IsNullOrWhiteSpace(Input.ActivityName) ? "General" : Input.ActivityName.Trim();
        var activity = await context.UserActivity.FirstOrDefaultAsync(a => a.Name.ToLower() == actName.ToLower() && a.UserId == currentUserId);
        if (activity == null)
        {
            activity = new UserActivity { Name = actName, UserId = currentUserId };
            context.UserActivity.Add(activity);
            await context.SaveChangesAsync();
        }

        var newEvent = new CalendarEvent
        {
            EventName = Input.EventName,
            Location = Input.Location,
            StartDateTime = Input.StartDateTime,
            EndDateTime = Input.EndDateTime,
            CalendarType = Input.CalendarType,
            HostUserId = currentUserId,
            UserActivityId = activity.Id,
            CreatedBy = authState.User.Identity?.Name,
            DateCreated = DateTime.Now,
            Description = Input.Description
        };
        context.CalendarEvent.Add(newEvent);

        foreach (var item in inviteStatusList)
        {
            var regUser = await context.Users.FirstOrDefaultAsync(u => u.Email.ToLower() == item.Email.ToLower());
            context.EventParticipant.Add(new EventParticipant
            {
                CalendarEvent = newEvent,
                UserId = regUser?.Id,
                InviteeEmail = item.Email,
                EventRoleId = 2,
                ParticipationStatus = "Pending"
            });
        }

        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/calendarevents?success=true");
    }

    private sealed class EventInputModel
    {
        [Required] public string EventName { get; set; } = "";
        [Required] public string Location { get; set; } = "";
        public string ActivityName { get; set; } = "General";
        public DateTime StartDateTime { get; set; }
        public DateTime EndDateTime { get; set; }
        public string CalendarType { get; set; } = "Work";
        public string InvitedEmails { get; set; } = "";
        public string Description { get; set; } = "";
    }
}