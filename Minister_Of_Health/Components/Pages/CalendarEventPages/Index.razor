@page "/calendarevents"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Minister_Of_Time.Data
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@attribute [Authorize]
@implements IAsyncDisposable
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Calendar Dashboard</PageTitle>

<div class="dashboard-container @(showPopup ? "blur-content" : "")">
    <aside class="sidebar-dark">
        <div class="sidebar-header">
            <h2 class="text-white">@displayDate.ToString("MMMM")</h2>
            <p class="text-muted">@displayDate.Year</p>
        </div>

        <button class="btn btn-primary w-100 my-4"
                @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={DateTime.Today:yyyy-MM-dd}")'>
            + Create Event
        </button>

        <div class="mini-agenda">
            <h6 class="text-uppercase text-info small fw-bold">Upcoming Today</h6>
            @foreach (var ev in userEvents.Where(e => e.StartDateTime.Date == DateTime.Today).Take(3))
            {
                <div class="agenda-card">
                    <span class="dot @ev.CalendarType?.ToLower()"></span>
                    <div class="agenda-info">
                        <div class="event-name">@ev.EventName</div>
                        <div class="event-time">@ev.StartDateTime.ToString("h:mm tt")</div>
                    </div>
                </div>
            }
        </div>
    </aside>

    <main class="calendar-main">
        <header class="grid-nav d-flex justify-content-between align-items-center p-3">
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ChangeMonth(-1)">Previous</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ChangeMonth(1)">Next</button>
            </div>
            <h4 class="mb-0">@displayDate.ToString("MMMM yyyy")</h4>
            <div class="view-toggle">
                <span class="badge bg-primary">Month</span>
            </div>
        </header>

        @* SUCCESS TOAST *@
        @if (Success)
        {
            <div class="alert alert-success alert-dismissible fade show mx-3 shadow-sm" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> Event created successfully!
                <button type="button" class="btn-close" @onclick="() => Success = false"></button>
            </div>
        }

        <div class="calendar-grid">
            @foreach (var dayName in Enum.GetNames(typeof(DayOfWeek)))
            {
                <div class="grid-header-day">@dayName.Substring(0, 3).ToUpper()</div>
            }

            @foreach (var day in daysInMonth)
            {
                <div class="calendar-cell @(day == DateTime.MinValue ? "empty" : "") @(day.Date == DateTime.Today ? "is-today" : "")"
                     @onclick="() => OpenDayDetails(day)">
                    @if (day != DateTime.MinValue)
                    {
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="day-num">@day.Day</span>
                            @* NEW: QUICK ADD BUTTON IN CELL *@
                            <a href="/calendarevents/create?date=@day.ToString("yyyy-MM-dd")"
                               class="btn btn-link p-0 text-primary opacity-50 hover-opacity-100"
                               @onclick:stopPropagation="true" title="Add Event">
                                <i class="bi bi-plus-circle-fill"></i>
                            </a>
                        </div>
                        <div class="event-pills-container">
                            @foreach (var ev in userEvents.Where(e => day.Date >= e.StartDateTime.Date && day.Date <= e.EndDateTime.Date))
                            {
                                <div class="event-pill @ev.CalendarType?.ToLower() @(ev.StartDateTime.Date != ev.EndDateTime.Date ? "is-multi-day" : "")">
                                    @ev.EventName
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </main>
</div>

@if (showPopup)
{
    <div class="modal-overlay" @onclick="ClosePopup">
        <div class="modal-window shadow-lg" @onclick:stopPropagation="true">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0 text-dark">Events for @selectedDate?.ToString("MMMM dd, yyyy")</h4>
                <button type="button" class="btn-close" @onclick="ClosePopup"></button>
            </div>
            <div class="modal-body mt-3">
                @if (selectedDayEvents.Any())
                {
                    @foreach (var ev in selectedDayEvents)
                    {
                        <div class="event-detail-card border rounded p-3 mb-3 bg-white">
                            <div class="d-flex justify-content-between">
                                <h5 class="text-primary fw-bold">@ev.EventName</h5>
                                <span class="badge @(ev.CalendarType == "Work" ? "bg-primary" : "bg-success")">@ev.CalendarType</span>
                            </div>
                            <hr class="my-2" />
                            <div class="row g-2">
                                <div class="col-12">
                                    <i class="bi bi-clock"></i> <strong>Time & Duration:</strong> <br />
                                    <span class="text-muted">
                                        @ev.StartDateTime.ToString("h:mm tt") &rarr; @ev.EndDateTime.ToString("h:mm tt")
                                        @{
                                            var duration = ev.EndDateTime - ev.StartDateTime;
                                            <span class="badge bg-light text-dark border ms-2">
                                                @(duration.TotalHours >= 1 ? $"{(int)duration.TotalHours}h " : "")@(duration.Minutes)m
                                            </span>
                                        }
                                    </span>
                                </div>
                                <div class="col-12 mt-2">
                                    <i class="bi bi-geo-alt"></i> <strong>Location:</strong> @ev.Location
                                </div>
                            </div>
                        </div>
                    }
                    @* ALLOW CREATING ANOTHER EVENT EVEN IF SOME EXIST *@
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-outline-primary"
                                @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={selectedDate?.ToString("yyyy-MM-dd")}")'>
                            + Add another event for this day
                        </button>
                    </div>
                }
                else
                {
                    <div class="text-center py-4 text-muted">
                        <p>No events found for this day.</p>
                        <button class="btn btn-sm btn-outline-primary"
                                @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={selectedDate?.ToString("yyyy-MM-dd")}")'>
                            Add one now
                        </button>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePopup">Close</button>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public bool Success { get; set; }
    private Minister_Of_TimeContext context = default!;
    private DateTime displayDate = DateTime.Today;
    private List<DateTime> daysInMonth = new();
    private List<CalendarEvent> userEvents = new();
    private string currentUserId = "";
    private bool showPopup = false;
    private DateTime? selectedDate;
    private List<CalendarEvent> selectedDayEvents = new();

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim != null) currentUserId = userIdClaim.Value;
        }
        await RefreshCalendarData();
    }

    private async Task RefreshCalendarData()
    {
        daysInMonth.Clear();
        var firstDayOfMonth = new DateTime(displayDate.Year, displayDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        int padding = (int)firstDayOfMonth.DayOfWeek;
        for (int i = 0; i < padding; i++) daysInMonth.Add(DateTime.MinValue);
        int daysCount = DateTime.DaysInMonth(displayDate.Year, displayDate.Month);
        for (int i = 1; i <= daysCount; i++) daysInMonth.Add(new DateTime(displayDate.Year, displayDate.Month, i));

        var hostedEvents = await context.CalendarEvent
            .Where(e => e.HostUserId == currentUserId && e.StartDateTime <= lastDayOfMonth && e.EndDateTime >= firstDayOfMonth)
            .ToListAsync();

        var joinedEvents = await context.EventParticipant
            .Include(p => p.CalendarEvent)
            .Where(p => p.UserId == currentUserId && p.ParticipationStatus == "Accepted" && p.CalendarEvent.StartDateTime <= lastDayOfMonth && p.CalendarEvent.EndDateTime >= firstDayOfMonth)
            .Select(p => p.CalendarEvent)
            .ToListAsync();

        userEvents = hostedEvents.Concat(joinedEvents).Distinct().ToList();
    }

    private async Task ChangeMonth(int increment)
    {
        displayDate = displayDate.AddMonths(increment);
        await RefreshCalendarData();
    }

    private void OpenDayDetails(DateTime day)
    {
        if (day == DateTime.MinValue) return;
        selectedDate = day;
        selectedDayEvents = userEvents.Where(e => day.Date >= e.StartDateTime.Date && day.Date <= e.EndDateTime.Date).ToList();
        showPopup = true;
    }

    private void ClosePopup() => showPopup = false;
    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}