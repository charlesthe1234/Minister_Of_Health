@page "/calendarevents"
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<div class="dashboard-container @(showPopup ? "blur-content" : "")">

    @* --- SIDEBAR --- *@
    <aside class="sidebar-dark">
        <div class="sidebar-header mb-4">
            <h2 class="text-white mb-0">@currentMonth.ToString("MMMM")</h2>
            <p class="text-muted">@currentMonth.Year</p>
        </div>

        <div class="filter-section">
            <p class="text-muted small fw-bold text-uppercase mb-3">Activity Filters</p>
            @foreach (var filter in ActivityFilters)
            {
                <div class="filter-item d-flex align-items-center mb-2">
                    <input type="checkbox" class="form-check-input me-2" checked="@filter.Value" @onchange="(e) => ToggleFilter(filter.Key, e.Value)" />
                    <span class="dot @Sanitize(filter.Key)"></span>
                    <span class="text-white-50 small">@filter.Key</span>
                </div>
            }
        </div>

        <div class="mt-auto">
            <button class="btn btn-primary w-100 shadow-sm py-2" @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={DateTime.Today:yyyy-MM-dd}")'>
                <i class="bi bi-plus-lg me-2"></i>Create Event
            </button>
        </div>
    </aside>

    @* --- MAIN CALENDAR (Scrollable) --- *@
    <main class="calendar-main">
        <div class="d-flex justify-content-between align-items-center p-3 bg-white border-bottom sticky-top">
            <h4 class="fw-bold mb-0">@currentMonth.ToString("MMMM yyyy")</h4>

            <div class="d-flex align-items-center gap-2">
                <div class="btn-group shadow-sm">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="PrevMonth">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary px-3 fw-bold" @onclick="GoToToday">
                        Today
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="NextMonth">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="calendar-grid">
            @foreach (var day in DaysOfWeek)
            {
                <div class="grid-header-day sticky-top bg-light">@day</div>
            }

            @foreach (var date in calendarDays)
            {
                var events = GetEventsForDate(date);
                bool isToday = date.Date == DateTime.Today;
                bool isCurrentMonth = date.Month == currentMonth.Month;

                <div class="calendar-cell @(isCurrentMonth ? "" : "text-muted bg-light-subtle opacity-50") @(isToday ? "is-today" : "")"
                     @onclick="() => OpenPopup(date)">
                    <div class="day-num">@date.Day</div>

                    <div class="event-pills-container">
                        @foreach (var ev in events.Take(3))
                        {
                            var pillClass = $"event-pill {GetCssClass(ev)}";
                            <div class="@pillClass">
                                @if (ev.Status == "Pending")
                                {
                                    <i class="bi bi-envelope-fill me-1" style="font-size: 0.7rem;"></i>
                                }
                                @ev.Event.EventName
                            </div>
                        }
                        @if (events.Count > 3)
                        {
                            <div class="more-indicator text-muted" style="font-size: 0.65rem; margin-top: 2px;">
                                + @(events.Count - 3) more
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </main>
</div>

@* --- POPUP MODAL --- *@
@if (showPopup)
{
    <div class="modal-overlay" @onclick="ClosePopup">
        <div class="modal-window shadow-lg" style="overflow-y: auto;" @onclick:stopPropagation="true">
            <div class="modal-header d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="fw-bold mb-0 text-dark">@selectedDate?.ToString("MMMM dd")</h4>
                    <span class="badge bg-light text-muted border">@selectedDate?.ToString("dddd")</span>
                </div>
                <button type="button" class="btn-close" @onclick="ClosePopup"></button>
            </div>

            <button class="btn btn-outline-primary w-100 mb-4 border-dashed py-2"
                    @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={selectedDate?.ToString("yyyy-MM-dd")}")'>
                <i class="bi bi-calendar-plus me-2"></i>Create an event for this day
            </button>

            <div class="event-list">
                @if (selectedDayEvents.Any())
                {
                    @foreach (var item in selectedDayEvents)
                    {
                        var duration = item.Event.EndDateTime - item.Event.StartDateTime;

                        <div class="event-detail-card p-3 border rounded mb-3 bg-white shadow-sm border-start border-4 @GetCssClass(item)">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h5 class="fw-bold text-dark mb-1">@item.Event.EventName</h5>
                                    <div class="d-flex gap-2 align-items-center flex-wrap">
                                        <span class="duration-tag small text-muted bg-light px-2 py-1 rounded border">
                                            <i class="bi bi-clock-history me-1"></i>@(duration.TotalHours >= 1 ? $"{(int)duration.TotalHours}h {duration.Minutes}m" : $"{duration.Minutes}m")
                                        </span>
                                        <span class="badge @GetStatusBadge(item.Event.Status)">@item.Event.Status</span>
                                        <span class="badge bg-secondary text-white">
                                            <i class="bi bi-person-badge me-1"></i>@item.Role
                                        </span>
                                    </div>
                                </div>
                                <span class="badge rounded-pill @GetActivityTypeBadge(item.Event.UserActivity?.ActivityType?.TypeName)">
                                    @(item.Event.UserActivity?.ActivityType?.TypeName ?? "Others")
                                </span>
                            </div>

                            <div class="small text-muted mb-3">
                                <div class="mb-1"><i class="bi bi-clock me-2"></i>@item.Event.StartDateTime.ToString("h:mm tt") - @item.Event.EndDateTime.ToString("h:mm tt")</div>
                                @if (!string.IsNullOrEmpty(item.Event.Location))
                                {
                                    <div class="text-primary fw-bold"><i class="bi bi-geo-alt-fill me-2"></i>@item.Event.Location</div>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(item.Event.Description))
                            {
                                <div class="description-box p-2 mb-3 bg-light rounded small text-dark">
                                    <strong>Description:</strong> @item.Event.Description
                                </div>
                            }

                            @if (item.Status == "Pending")
                            {
                                <div class="alert alert-warning py-2 px-3 d-flex justify-content-between align-items-center">
                                    <span class="small fw-bold">Accept Invite?</span>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-success" @onclick="() => Respond(item.ParticipantId, true)">Yes</button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => Respond(item.ParticipantId, false)">No</button>
                                    </div>
                                </div>
                            }

                            <div class="d-grid gap-2 pt-2 border-top">
                                @if (item.Role == "Host" || (item.Role == "Editor" && item.Status == "Accepted"))
                                {
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-primary flex-grow-1" @onclick='() => NavigationManager.NavigateTo($"/calendarevents/edit/{item.Event.Id}")'>
                                            <i class="bi bi-pencil me-1"></i>Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary flex-grow-1" @onclick='() => NavigationManager.NavigateTo($"/calendarevents/manage-invites/{item.Event.Id}")'>
                                            <i class="bi bi-people me-1"></i>Invites
                                        </button>
                                    </div>
                                }

                                @if (item.Role != "Host")
                                {
                                    <button class="btn btn-outline-danger btn-sm w-100 py-1 mt-1 d-flex align-items-center justify-content-center gap-2" @onclick="() => LeaveEvent(item.Event.Id)">
                                        <i class="bi bi-box-arrow-right"></i> Leave Event
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-calendar-x display-6"></i>
                        <p class="mt-2">No events scheduled.</p>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public int? EventId { get; set; }

    private DateTime currentMonth = DateTime.Today;
    private List<DateTime> calendarDays = new();
    private string[] DaysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    private Dictionary<string, bool> ActivityFilters = new() {
        { "Work", true },
        { "Meetings", true },
        { "Hobby", true },
        { "Life", true },
        { "Family Time", true },
        { "Others", true },
        { "Invites", true }
    };

    private string? currentUserId;
    private List<DisplayItem> allEvents = new();
    private List<DisplayItem> selectedDayEvents = new();
    private DateTime? selectedDate;
    private bool showPopup = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        GenerateCalendar();
        await LoadData();

        if (EventId.HasValue)
        {
            var eventItem = allEvents.FirstOrDefault(e => e.Event.Id == EventId.Value);
            if (eventItem != null)
            {
                OpenPopup(eventItem.Event.StartDateTime.Date);
            }
        }
    }

    private async Task LoadData()
    {
        using var context = DbFactory.CreateDbContext();

        // 1. Get all participation records for the current user first
        // Including EventRole is critical here so we can see "Editor"
        var participation = await context.EventParticipant
            .Where(p => p.UserId == currentUserId)
            .Include(p => p.EventRole)
            .ToListAsync();

        var participantEventIds = participation.Select(p => p.CalendarEventId).ToList();

        // 2. Fetch the events
        var events = await context.CalendarEvent
            .Include(e => e.UserActivity)
            .Where(e => e.HostUserId == currentUserId || participantEventIds.Contains(e.Id))
            .ToListAsync();

        // 3. Map to DisplayItem
        allEvents = events.Select(e =>
        {
            var pRecord = participation.FirstOrDefault(p => p.CalendarEventId == e.Id);

            // Determine Role: Host always wins, otherwise use the database RoleName
            string assignedRole = "Viewer";
            if (e.HostUserId == currentUserId)
            {
                assignedRole = "Host";
            }
            else if (pRecord?.EventRole != null)
            {
                assignedRole = pRecord.EventRole.RoleName; // Ensure this matches "Editor" exactly
            }

            return new DisplayItem
            {
                Event = e,
                Status = pRecord?.ParticipationStatus ?? "Accepted",
                Role = assignedRole,
                ParticipantId = pRecord?.Id ?? 0
            };
        })
        .Where(x => x.Status != "Left" && x.Status != "Rejected")
        .ToList();

        allEvents = events.Select(e =>
        {
            var pRecord = participation.FirstOrDefault(p => p.CalendarEventId == e.Id);
            return new DisplayItem
            {
                Event = e,
                Status = pRecord?.ParticipationStatus ?? "Accepted",
                Role = e.HostUserId == currentUserId ? "Host" : pRecord?.EventRole?.RoleName ?? "Viewer",
                ParticipantId = pRecord?.Id ?? 0
            };
        })
        .Where(x => x.Status != "Left" && x.Status != "Rejected")
        .ToList();
    }

    private void GenerateCalendar()
    {
        calendarDays.Clear();
        var start = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        int offset = (int)start.DayOfWeek;
        var drawDate = start.AddDays(-offset);
        for (int i = 0; i < 42; i++)
        {
            calendarDays.Add(drawDate.AddDays(i));
        }
    }

    private List<DisplayItem> GetEventsForDate(DateTime date)
    {
        return allEvents.Where(e => e.Event.StartDateTime.Date <= date.Date && e.Event.EndDateTime.Date >= date.Date)
            .Where(e =>
            {
                if (e.Status == "Pending") return ActivityFilters["Invites"];
                var type = e.Event.UserActivity?.ActivityType?.TypeName ?? "Others";
                return ActivityFilters.ContainsKey(type) && ActivityFilters[type];
            }).ToList();
    }

    private void ToggleFilter(string key, object? val)
    {
        ActivityFilters[key] = (bool)(val ?? true);
        StateHasChanged();
    }

    private async Task Respond(int id, bool accept)
    {
        using var context = DbFactory.CreateDbContext();
        var p = await context.EventParticipant.FindAsync(id);
        if (p != null)
        {
            p.ParticipationStatus = accept ? "Accepted" : "Rejected";
            await context.SaveChangesAsync();
            await LoadData();
            if (selectedDate.HasValue) selectedDayEvents = GetEventsForDate(selectedDate.Value);
        }
    }

    private async Task LeaveEvent(int eventId)
    {
        using var context = DbFactory.CreateDbContext();
        var p = await context.EventParticipant.FirstOrDefaultAsync(x => x.CalendarEventId == eventId && x.UserId == currentUserId);
        if (p != null)
        {
            p.ParticipationStatus = "Left";
            await context.SaveChangesAsync();
            await LoadData();
            showPopup = false;
        }
    }

    private string GetCssClass(DisplayItem item)
    {
        if (item.Status == "Pending") return "pending-invite";
        var typeString = item.Event.UserActivity?.ActivityType?.TypeName ?? "Others";
        return Sanitize(typeString);
    }

    private string Sanitize(string input) => input.ToLower().Replace(" ", "");

    private string GetActivityTypeBadge(string? type)
    {
        return (type ?? "Others") switch
        {
            "Work" => "bg-primary text-white",
            "Meetings" => "bg-info text-dark",
            "Hobby" => "bg-success text-white",
            "Life" => "bg-warning text-dark",
            "Family Time" => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }

    private string GetStatusBadge(string? status)
    {
        return (status ?? "Upcoming") switch
        {
            "Ongoing" => "bg-success text-white",
            "Concluded" => "bg-secondary text-white",
            "On Hold" => "bg-warning text-dark",
            _ => "bg-info text-dark"
        };
    }

    private void OpenPopup(DateTime d) { selectedDate = d; selectedDayEvents = GetEventsForDate(d); showPopup = true; }
    private void ClosePopup() => showPopup = false;
    private void PrevMonth() { currentMonth = currentMonth.AddMonths(-1); GenerateCalendar(); }
    private void NextMonth() { currentMonth = currentMonth.AddMonths(1); GenerateCalendar(); }
    private void GoToToday() { currentMonth = DateTime.Today; GenerateCalendar(); }

    public class DisplayItem
    {
        public CalendarEvent Event { get; set; } = default!;
        public string Status { get; set; } = "";
        public string Role { get; set; } = "";
        public int ParticipantId { get; set; }
    }
}