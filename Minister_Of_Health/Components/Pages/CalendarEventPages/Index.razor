@page "/calendarevents"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Minister_Of_Time.Data
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@attribute [Authorize]
@implements IAsyncDisposable
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Calendar Dashboard</PageTitle>

<div class="dashboard-container @(showPopup ? "blur-content" : "")">
    <aside class="sidebar-dark">
        <div class="sidebar-header">
            <h2 class="text-white">@displayDate.ToString("MMMM")</h2>
            <p class="text-muted">@displayDate.Year</p>
        </div>

        <button class="btn btn-primary w-100 my-4 shadow-sm"
                @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={DateTime.Today:yyyy-MM-dd}")'>
            <i class="bi bi-plus-lg"></i> + Create Event
        </button>

        <div class="mini-agenda">
            <h6 class="text-uppercase text-info small fw-bold">Upcoming Today</h6>
            @foreach (var item in userEvents.Where(e => e.Event.StartDateTime.Date == DateTime.Today).Take(3))
            {
                <div class="agenda-card">
                    <span class="dot @item.Event.CalendarType?.ToLower()"></span>
                    <div class="agenda-info">
                        <div class="event-name">@item.Event.EventName</div>
                        <div class="event-time">@item.Event.StartDateTime.ToString("h:mm tt")</div>
                    </div>
                </div>
            }
        </div>
    </aside>

    <main class="calendar-main">
        <header class="grid-nav d-flex justify-content-between align-items-center p-3">
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ChangeMonth(-1)">Previous</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ChangeMonth(1)">Next</button>
            </div>
            <h4 class="mb-0">@displayDate.ToString("MMMM yyyy")</h4>
            <div class="view-toggle">
                <span class="badge bg-primary">Month</span>
            </div>
        </header>

        @if (Success)
        {
            <div class="alert alert-success alert-dismissible fade show mx-3 shadow-sm" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> Action successful!
                <button type="button" class="btn-close" @onclick="() => Success = false"></button>
            </div>
        }

        <div class="calendar-grid">
            @foreach (var dayName in Enum.GetNames(typeof(DayOfWeek)))
            {
                <div class="grid-header-day">@dayName.Substring(0, 3).ToUpper()</div>
            }

            @foreach (var day in daysInMonth)
            {
                <div class="calendar-cell @(day == DateTime.MinValue ? "empty" : "") @(day.Date == DateTime.Today ? "is-today" : "")"
                     @onclick="() => OpenDayDetails(day)">
                    @if (day != DateTime.MinValue)
                    {
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="day-num">@day.Day</span>
                            <a href="/calendarevents/create?date=@day.ToString("yyyy-MM-dd")"
                               class="btn btn-link p-0 text-primary"
                               @onclick:stopPropagation="true">
                                <i class="bi bi-plus-circle-fill"></i>
                            </a>
                        </div>
                        <div class="event-pills-container">
                            @foreach (var item in userEvents.Where(e => day.Date >= e.Event.StartDateTime.Date && day.Date <= e.Event.EndDateTime.Date))
                            {
                                <div class="event-pill @item.Event.CalendarType?.ToLower()">
                                    @item.Event.EventName
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </main>
</div>

@if (showPopup)
{
    <div class="modal-overlay" @onclick="ClosePopup">
        <div class="modal-window shadow-lg" @onclick:stopPropagation="true">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0 text-dark">@selectedDate?.ToString("MMMM dd, yyyy")</h4>
                <button type="button" class="btn-close" @onclick="ClosePopup"></button>
            </div>
            <div class="modal-body mt-3">

                <div class="d-grid mb-3">
                    <button class="btn btn-outline-primary shadow-sm"
                            @onclick='() => NavigationManager.NavigateTo($"/calendarevents/create?date={selectedDate?.ToString("yyyy-MM-dd")}")'>
                        <i class="bi bi-calendar-plus-fill"></i> + Add an event for this day
                    </button>
                </div>

                @if (selectedDayEvents.Any())
                {
                    @foreach (var item in selectedDayEvents)
                    {
                        <div class="event-detail-card border rounded p-3 mb-3 bg-white shadow-sm">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="text-dark fw-bold mb-1">@item.Event.EventName</h5>
                                    @* COLOR CODED ROLE BADGE INTEGRATED *@
                                    <span class="badge @GetRoleClass(item.Role) x-small">
                                        <i class="bi bi-shield-lock-fill me-1"></i>@item.Role
                                    </span>
                                </div>
                                <span class="badge @(item.Event.CalendarType == "Work" ? "bg-info text-dark" : "bg-success")">
                                    @item.Event.CalendarType
                                </span>
                            </div>
                            <hr class="my-2" />
                            <div class="row g-2 small mb-3">
                                <div class="col-12 text-dark">
                                    <i class="bi bi-clock"></i> <strong>Time:</strong>
                                    @item.Event.StartDateTime.ToString("h:mm tt") &rarr; @item.Event.EndDateTime.ToString("h:mm tt")
                                </div>
                                <div class="col-12 text-muted">
                                    <i class="bi bi-hourglass-split"></i> <strong>Duration:</strong> @item.GetDuration()
                                </div>
                                <div class="col-12 text-dark">
                                    <i class="bi bi-geo-alt"></i> <strong>Location:</strong> @item.Event.Location
                                </div>
                            </div>

                            @if (item.Role == "Host" || item.Role == "Editor")
                            {
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-grow-1"
                                            @onclick='() => NavigationManager.NavigateTo($"/calendarevents/edit/{item.Event.Id}")'>
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary flex-grow-1"
                                            @onclick='() => NavigationManager.NavigateTo($"/calendarevents/manage-invites/{item.Event.Id}")'>
                                        <i class="bi bi-people"></i> Invites
                                    </button>
                                </div>
                            }
                            @if (item.Role != "Host")
                            {
                                <div class="d-flex pt-2 border-top">
                                    <button class="btn btn-sm btn-outline-danger flex-grow-1" @onclick="() => LeaveEvent(item.Event.Id)">
                                        <i class="bi bi-box-arrow-right"></i> Leave Event
                                    </button>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-4 text-muted border rounded bg-light">
                        <p class="mb-0">No events found for this day.</p>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePopup">Close</button>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public bool Success { get; set; }
    private Minister_Of_TimeContext context = default!;
    private DateTime displayDate = DateTime.Today;
    private List<DateTime> daysInMonth = new();
    private List<EventDisplayItem> userEvents = new();
    private List<EventDisplayItem> selectedDayEvents = new();
    private string currentUserId = "";
    private bool showPopup = false;
    private DateTime? selectedDate;

    // ADDED: Role color logic helper
    private string GetRoleClass(string? roleName) => roleName switch
    {
        "Host" => "bg-warning text-dark",
        "Editor" => "bg-primary text-white",
        "Viewer" => "bg-secondary text-white",
        _ => "bg-light text-dark"
    };

    private class EventDisplayItem
    {
        public CalendarEvent Event { get; set; } = default!;
        public string Role { get; set; } = "Viewer";

        public string GetDuration()
        {
            var diff = Event.EndDateTime - Event.StartDateTime;
            if (diff.TotalDays >= 1)
                return $"{(int)diff.TotalDays}d {diff.Hours}h {diff.Minutes}m";
            return $"{diff.Hours}h {diff.Minutes}m";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
        await RefreshCalendarData();
    }

    private async Task RefreshCalendarData()
    {
        daysInMonth.Clear();
        var firstDayOfMonth = new DateTime(displayDate.Year, displayDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        var hosted = await context.CalendarEvent
            .Where(e => e.HostUserId == currentUserId && e.StartDateTime <= lastDayOfMonth && e.EndDateTime >= firstDayOfMonth)
            .Select(e => new EventDisplayItem { Event = e, Role = "Host" })
            .ToListAsync();

        var joined = await context.EventParticipant
            .Include(p => p.CalendarEvent)
            .Include(p => p.EventRole)
            .Where(p => p.UserId == currentUserId && (p.ParticipationStatus == "Accepted" || p.ParticipationStatus == "Pending")
                   && p.CalendarEvent.StartDateTime <= lastDayOfMonth && p.CalendarEvent.EndDateTime >= firstDayOfMonth)
            .Select(p => new EventDisplayItem { Event = p.CalendarEvent, Role = p.EventRole.RoleName })
            .ToListAsync();

        userEvents = hosted.Concat(joined).GroupBy(x => x.Event.Id).Select(g => g.First()).ToList();

        int padding = (int)firstDayOfMonth.DayOfWeek;
        for (int i = 0; i < padding; i++) daysInMonth.Add(DateTime.MinValue);
        int daysCount = DateTime.DaysInMonth(displayDate.Year, displayDate.Month);
        for (int i = 1; i <= daysCount; i++) daysInMonth.Add(new DateTime(displayDate.Year, displayDate.Month, i));
    }

    private async Task ChangeMonth(int increment)
    {
        displayDate = displayDate.AddMonths(increment);
        await RefreshCalendarData();
    }

    private void OpenDayDetails(DateTime day)
    {
        if (day == DateTime.MinValue) return;
        selectedDate = day;
        selectedDayEvents = userEvents.Where(e => day.Date >= e.Event.StartDateTime.Date && day.Date <= e.Event.EndDateTime.Date).ToList();
        showPopup = true;
    }

    private async Task LeaveEvent(int eventId) //function to leave event for non host
    {
        using var dbContext = DbFactory.CreateDbContext();
        var participant = await dbContext.EventParticipant
            .FirstOrDefaultAsync(p => p.CalendarEventId == eventId && p.UserId == currentUserId);

        if (participant != null)
        {
            participant.ParticipationStatus = "Left"; // Set status to Left instead of deleting
            await dbContext.SaveChangesAsync();
            showPopup = false;
            await RefreshCalendarData(); // Refresh UI to remove the event pill
        }
    }

    private void ClosePopup() => showPopup = false;
    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}