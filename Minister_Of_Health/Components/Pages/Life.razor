@page "/life"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Minister_Of_Time.Domain
@rendermode InteractiveServer

@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<User> UserManager
@inject IDbContextFactory<Minister_Of_TimeContext> DbFactory
<PageTitle>Life Page</PageTitle>

<div class="life-background">

        <div class="charts-wrapper">
            <div class="chart-box">
                <h2 style="color: white;">Distribution</h2>
                <canvas id="lifePieChart"></canvas>
            </div>

            <div class="chart-box">
                <h2 style="color: white;">Weekly Progress</h2>
                <canvas id="lifeLineChart"></canvas>
            </div>
        </div>

    <div class="logo-title-container">
        <img src="/images/BigLogo.png" class="life-logo-image" alt="Minister of Time Logo" />
        <h1 class="life-main-title">Dear Charles</h1>
        <blockquote class="life-quote">"Caring for yourself is not self-indulgence, it is self-preservation, and that is an act of political warfare."</blockquote>
    </div>

    <a href="/home" class="life-link events-link">Back</a>

</div>

@code {
    private string DisplayName = "User";
    private List<double> chartData = new();
    private List<string> chartLabels = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;
        if (userClaims.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            var userIdString = UserManager.GetUserId(userClaims);
            var dbUser = await context.Users.FirstOrDefaultAsync(u => u.Id.ToString() == userIdString);
            if (dbUser != null) DisplayName = dbUser.Name ?? "User";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdString = UserManager.GetUserId(user);

                Console.WriteLine($"CONNECTED USER ID: {userIdString}");// Check user ID

                using var context = DbFactory.CreateDbContext();

                // Fetch events
                var events = await context.CalendarEvent
                    .Include(e => e.UserActivity)
                    .Where(e => e.HostUserId.ToString() == userIdString)
                    .ToListAsync();

                Console.WriteLine($"MATCHES FOUND: {events.Count}");// Check how many events were found

                // Inside OnAfterRenderAsync, after fetching 'events'
                if (events.Any())
                {
                    var groupedData = events
                        .GroupBy(e => e.UserActivity?.ActivityType ?? "Other")//This line will determine the category of pie chart
                        .Select(g => new
                        {
                            Category = g.Key,
                            Minutes = g.Sum(e => (e.EndDateTime - e.StartDateTime).TotalMinutes)
                        }).ToList();

                    var chartLabels = groupedData.Select(x => x.Category).ToList();
                    var chartData = groupedData.Select(x => x.Minutes).ToList();

                    // Send to the JS code
                    await JSRuntime.InvokeVoidAsync("renderLifeCharts", chartLabels, chartData);
                    // 1. Get the last 7 days as a list of strings for the X-axis labels
                    var lastSevenDays = Enumerable.Range(0, 7)
                        .Select(i => DateTime.Today.AddDays(-i).ToString("MM/dd"))
                        .Reverse()
                        .ToList();

                    // 2. Group events by Date and count them
                    var progressData = events
                        .Where(e => e.StartDateTime >= DateTime.Today.AddDays(-7))
                        .GroupBy(e => e.StartDateTime.ToString("MM/dd"))
                        .ToDictionary(g => g.Key, g => g.Count());

                    // 3. Match the counts to the specific 7 days (filling in 0 for days with no events)
                    var lineChartData = lastSevenDays
                        .Select(day => progressData.ContainsKey(day) ? (double)progressData[day] : 0.0)
                        .ToList();

                    // 4. Send both data sets to JS
                    await JSRuntime.InvokeVoidAsync("renderLifeCharts",
                        chartLabels, chartData, // Pie chart data
                        lastSevenDays, lineChartData // Line chart data
                    );
    
                    StateHasChanged();
                }
            }
        }
    }
}