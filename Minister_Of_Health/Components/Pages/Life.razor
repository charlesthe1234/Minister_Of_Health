@page "/life"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Minister_Of_Time.Domain
@rendermode InteractiveServer

@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<User> UserManager
@inject IDbContextFactory<Minister_Of_TimeContext> DbFactory
<PageTitle>Life Page</PageTitle>

<div class="life-background">

        <div class="charts-wrapper">
            <div class="chart-box">
                <h2 style="color: white;">Distribution</h2>
                <canvas id="lifePieChart"></canvas>
            </div>

            <div class="chart-box">
                <h2 style="color: white;">Recent days Record</h2>
                <canvas id="lifeLineChart"></canvas>
            </div>
        </div>

    <div class="logo-title-container">
        <img src="/images/BigLogo.png" class="life-logo-image" alt="Minister of Time Logo" />
        <h1 class="life-main-title">Dear @DisplayName</h1>
        <blockquote class="life-quote">"Caring for yourself is not self-indulgence, it is self-preservation, and that is an act of political warfare."</blockquote>
    </div>

    <a href="/home" class="life-link events-link">Back</a>

</div>

@code {
    private string DisplayName = "Guest";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;
        if (userClaims.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            var userIdString = UserManager.GetUserId(userClaims);
            var dbUser = await context.Users.FirstOrDefaultAsync(u => u.Id.ToString() == userIdString);
            if (dbUser != null) DisplayName = dbUser.Name ?? "Guest";//dnUser.Name vs dbUser.Identity.Name
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdString = UserManager.GetUserId(user);
                using var context = DbFactory.CreateDbContext();

                DisplayName = authState.User.FindFirst("FullName")?.Value;
                // Fetch events including the activity details
                var events = await context.CalendarEvent
                    .Include(e => e.UserActivity)
                    .ThenInclude(ua => ua.ActivityType)
                    .Where(e => e.HostUserId.ToString() == userIdString)
                    .ToListAsync();

                if (events.Any())
                {
                    // --- 1. PREPARE PIE CHART DATA (Accumulated Minutes) ---
                    var pieGrouped = events
                        .GroupBy(e => e.UserActivity?.ActivityType?.TypeName ?? "Other")
                        .Select(g => new
                        {
                            Category = g.Key,
                            Minutes = g.Sum(e => (e.EndDateTime - e.StartDateTime).TotalMinutes)
                        }).ToList();

                    var pieLabels = pieGrouped.Select(x => x.Category).ToList();
                    var pieValues = pieGrouped.Select(x => x.Minutes).ToList();

                    // --- 2. PREPARE LINE CHART DATA (Multi-series Hours) ---

                    // Create the X-axis labels (Last 7 Days)
                    var lastSevenDays = Enumerable.Range(0, 7)
                        .Select(i => DateTime.Today.AddDays(-i).ToString("MM/dd"))
                        .Reverse()
                        .ToList();

                    // Identify all unique activity types present in the last 7 days
                    var activityTypes = events
                        .Where(e => e.StartDateTime >= DateTime.Today.AddDays(-7))
                        .Select(e => e.UserActivity?.ActivityType?.TypeName ?? "Other")
                        .Distinct()
                        .ToList();

                    // Create a separate data series (line) for each Activity Type
                    var multiLineData = activityTypes.Select(type => new
                    {
                        Label = type,
                        Data = lastSevenDays.Select(day =>
                            events.Where(e => (e.UserActivity?.ActivityType?.TypeName ?? "Other") == type
                                           && e.StartDateTime.ToString("MM/dd") == day)
                                  .Sum(e => (e.EndDateTime - e.StartDateTime).TotalHours)
                        ).ToList()
                    }).ToList();

                    // --- 3. SEND TO JAVASCRIPT ---
                    // Passing 4 arguments: Pie Labels, Pie Values, Line Labels, Line Dataset Objects
                    await JSRuntime.InvokeVoidAsync("renderLifeCharts",
                        pieLabels,
                        pieValues,
                        lastSevenDays,
                        multiLineData
                    );

                    StateHasChanged();
                }
            }
        }
    }
}