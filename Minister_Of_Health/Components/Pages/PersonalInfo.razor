@page "/account/personalInfo"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Minister_Of_Time.Domain
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<div class="book">
    <div class="bg-image"></div>

    <div class="manage-content">
        @* Left Page: Profile Section *@
        <div class="profile-card">
            <h1 class="display-name">@DisplayName</h1>

            @if (!isEditing)
            {
                <div class="info-list">
                    <p><strong>Phone:</strong> @PhoneNumber</p>
                    <p><strong>Email:</strong> @Email</p>
                    <p><strong>Gender:</strong> @Gender</p>
                    <p><strong>Birthday:</strong> @(Birthday?.ToString("MM/dd/yyyy") ?? "Not Set")</p>
                </div>
                <button class="btn-edit" @onclick="() => isEditing = true">EDIT</button>
            }
            else
            {
                <div class="edit-form">
                    <div class="mb-2">
                        <label class="small fw-bold">Phone</label>
                        <input class="form-control form-control-sm" @bind="PhoneNumber" />
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Gender</label>
                        <select class="form-select form-select-sm" @bind="Gender">
                            <option value="">Select...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Birthday</label>
                        <input type="date" class="form-control form-control-sm" @bind="Birthday" />
                    </div>
                    <div class="edit-actions mt-3">
                        <button class="btn btn-sm btn-success me-2" @onclick="Save">Save</button>
                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditing = false">Cancel</button>
                    </div>
                </div>
            }
        </div>

        @* Right Page: Gauges Section *@
        <div class="right-column">
            @foreach (var gauge in new[] { ("STRESS", StressLevel, ""), ("HEALTH", HealthLevel, "health") })
            {
                <div class="gauge-block">
                    <div class="gauge-title">@gauge.Item1 LEVEL</div>
                    <div class="dial">
                        <div class="needle @gauge.Item3" style="transform: rotate(@(NeedleAngle(gauge.Item2))deg)"></div>
                    </div>
                    <div class="gauge-label">
                        @gauge.Item2%
                        (<span style="color: @GetStatusColor(gauge.Item2, gauge.Item1 == "STRESS")">
                            @(gauge.Item1 == "STRESS" ? GetStressStatus(gauge.Item2) : GetHealthStatus(gauge.Item2))
                        </span>)
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@if (showStressWarning)
{
    <div class="stress-alert-top">
        <div class="character-container">
            <img src="/images/SmallLogo.png" class="character-img" alt="Warning Character" />
            <div class="speech-bubble">
                <div class="bubble-content">
                    <strong>@DisplayName, your majesty</strong>
                    <p>
                        Your current stress level has reached @StressLevel%. It is not good for your health,
                        how about take some time to enjoy <strong>@RandomHobbyName</strong>?
                        You haven't done that for <strong>@FormattedRecentRecord</strong>.
                    </p>
                </div>
                <button type="button" class="btn-close-custom" @onclick="() => showStressWarning = false">×</button>
            </div>
        </div>
    </div>
}

@code {
    private string DisplayName = "User", PhoneNumber = "", Email = "", Gender = "";
    private DateTime? Birthday;
    private int StressLevel = 0;
    private int HealthLevel = 0;
    private bool isEditing;
    private bool showStressWarning = false;

    // New variables for the speech bubble
    private string RandomHobbyName = "";
    private string FormattedRecentRecord = "";

    [Inject] private IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory { get; set; }
    [Inject] private UserManager<User> UserManager { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;

        if (userClaims.Identity?.IsAuthenticated == true)
        {
            var userIdString = UserManager.GetUserId(userClaims);
            using var context = DbFactory.CreateDbContext();

            // 1. Fetch User Data
            var user = await UserManager.GetUserAsync(userClaims);
            if (user != null)
            {
                DisplayName = user.Name ?? "User";
                Email = user.Email ?? "";
                PhoneNumber = user.PhoneNumber ?? "";
                Gender = user.Gender ?? "";
                Birthday = user.Birthday;
            }

            // 2. Stress & Health Calculation (Your existing code)
            var threeDaysAgo = DateTime.Today.AddDays(-1);//start from yesterday
            var endOfToday = DateTime.Today.AddDays(2);// ends at tomorrow
            var recentEvents = await context.CalendarEvent
                .Include(e => e.UserActivity).ThenInclude(ua => ua.ActivityType)
                .Where(e => e.HostUserId.ToString() == userIdString 
                && e.StartDateTime >= threeDaysAgo
                && e.StartDateTime < endOfToday)
                .ToListAsync();

            if (recentEvents.Any())
            {
                double totalThreeDayScore = 0;
                double totalExerciseHours = 0;

                foreach (var ev in recentEvents)
                {
                    double hours = (ev.EndDateTime - ev.StartDateTime).TotalHours;
                    double weight = ev.UserActivity?.ActivityType?.StressLevel ?? 0;
                    totalThreeDayScore += (hours * weight);
                    if (ev.UserActivity?.ActivityType?.TypeName == "Exercise") totalExerciseHours += hours;
                }

                StressLevel = (int)Math.Clamp((totalThreeDayScore / 31.2) * 100, 0, 100);
                HealthLevel = (int)Math.Clamp((totalExerciseHours / 21) * 100, 0, 100);

                // 3. Logic for the Random Hobby Suggestion
                if (StressLevel > 50)
                {
                    var twoYearsAgo = DateTime.Now.AddYears(-2);
                    var oneMonthAgo = DateTime.Now.AddMonths(-1);

                    // Filter: Must be 'Hobby', within 1 month to 2 years, and belong to current user
                    var potentialHobbies = await context.UserActivity
                        .Include(a => a.ActivityType)
                        .Where(a => a.UserId == userIdString &&
                                    a.ActivityType.TypeName == "Hobby" &&
                                    a.RecentRecord >= twoYearsAgo &&
                                    a.RecentRecord <= oneMonthAgo)
                        .ToListAsync();

                    if (potentialHobbies.Any())
                    {
                        var random = new Random();
                        var selectedHobby = potentialHobbies[random.Next(potentialHobbies.Count)];

                        RandomHobbyName = selectedHobby.Name;

                        // Format the time since last done (e.g., "4 months")
                        var timeSpan = DateTime.Now - selectedHobby.RecentRecord;
                        int months = (int)(timeSpan.TotalDays / 30.44); // Average month length
                        FormattedRecentRecord = months >= 12 ? $"{(months / 12)} year(s)" : $"{months} month(s)";

                        showStressWarning = true;
                    }
                    else
                    {
                        // Fallback if no hobby within the time range
                        RandomHobbyName = "something you love";
                        FormattedRecentRecord = "quite a while";
                        showStressWarning = true;
                    }
                }
            }
        }
    }

    private async Task Save()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user != null)
        {
            // Update Identity User properties
            user.PhoneNumber = PhoneNumber;
            user.Gender = Gender;
            user.Birthday = Birthday;

            var result = await UserManager.UpdateAsync(user);
            if (result.Succeeded)
            {
                isEditing = false;
                StateHasChanged();
            }
        }
    }

    private string GetStatusColor(int level, bool isStress)
    {
        if (isStress)
        {
            if (level <= 30) return "#2e8b57"; //Green
            if (level <= 50) return "#daa520"; //orange
            if (level <= 80) return "#ff8c00"; //yellow
            return "#b03060"; //dark red
        }
        else
        {
            if (level <= 10) return "#FF0000";
            if (level <= 30) return "#FFA500";
            if (level <= 50) return "#FFFF00";
            if (level <= 70) return "#90EE90";
            return "#006400";
        }
    }

    private string GetStressStatus(int level) => level switch
    {
        <= 30 => "Comfort",
        <= 50 => "Stretch",
        <= 80 => "Overly Stressed",
        _ => "Burnout"
    };

    private string GetHealthStatus(int level) => level switch
    {
        <= 10 => "Poor",
        <= 30 => "Try More",
        <= 50 => "Standard",
        <= 70 => "Active",
        _ => "Excellent"
    };

    double NeedleAngle(int val) => (val * 1.8) - 90;
}