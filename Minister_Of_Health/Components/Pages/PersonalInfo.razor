@page "/account/personalInfo"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject AuthenticationStateProvider AuthStateProvider

<div class="book">
    <div class="bg-image"></div>

    <div class="manage-content">
        @* Profile Section *@
        <div class="profile-card">
            <h1 class="display-name">@DisplayName</h1>

            @if (!isEditing)
            {
                <div class="info-list">
                    <p><strong>Phone:</strong> @PhoneNumber</p>
                    <p><strong>Email:</strong> @Email</p>
                </div>
                <button class="btn-edit" @onclick="() => isEditing = true">EDIT</button>
            }
            else
            {
                <div class="edit-form">
                    <input class="form-control" @bind="PhoneNumber" placeholder="Phone" />
                    <input class="form-control" @bind="Email" placeholder="Email" />
                    <div class="edit-actions">
                        <button class="btn-save" @onclick="Save">Save</button>
                        <button class="btn-cancel" @onclick="() => isEditing = false">Cancel</button>
                    </div>
                </div>
            }
        </div>

        @* Gauges Section *@
        <div class="right-column">
            @foreach (var gauge in new[] { ("STRESS", StressLevel, ""), ("HEALTH", HealthLevel, "health") })
            {
                <div class="gauge-block">
                    <div class="gauge-title">@gauge.Item1 LEVEL</div>
                    <div class="dial">
                        <div class="needle @gauge.Item3" style="transform: rotate(@(NeedleAngle(gauge.Item2))deg)"></div>
                    </div>
                    @* Bracketed status text with dynamic color *@
                    <div class="gauge-label">
                        @gauge.Item2% 
                        (<span style="color: @GetStatusColor(gauge.Item2, gauge.Item1 == "STRESS")">
                            @(gauge.Item1 == "STRESS" ? GetStressStatus(gauge.Item2) : GetHealthStatus(gauge.Item2))
                        </span>)
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string DisplayName = "Unknown", PhoneNumber = "", Email = "";
    private int StressLevel = 0;
    private int HealthLevel = 0;
    private bool isEditing;

    [Inject] private IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory { get; set; }
    [Inject] private UserManager<User> UserManager { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;

        if (userClaims.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            var userIdString = UserManager.GetUserId(userClaims);
            DisplayName = userClaims.FindFirst("FullName")?.Value ?? "User";
            Email = userClaims.Identity.Name ?? "";

            var threeDaysAgo = DateTime.Today.AddDays(-2);

            var recentEvents = await context.CalendarEvent
                .Include(e => e.UserActivity).ThenInclude(ua => ua.ActivityType)
                .Where(e => e.HostUserId.ToString() == userIdString && e.StartDateTime >= threeDaysAgo)
                .ToListAsync();

            if (recentEvents.Any())
            {
                double totalThreeDayScore = 0;
                double totalExerciseHours = 0;

                foreach (var ev in recentEvents)
                {
                    double hours = (ev.EndDateTime - ev.StartDateTime).TotalHours;

                    // Stress calculation logic
                    double weight = ev.UserActivity?.ActivityType?.StressLevel ?? 0;
                    totalThreeDayScore += (hours * weight);

                    // Health logic: Sum hours where type is 'Exercise'
                    if (ev.UserActivity?.ActivityType?.TypeName == "Exercise")
                    {
                        totalExerciseHours += hours;
                    }
                }

                // Stress Threshold: 16hrs work avg/day = 100% capacity limit
                double maxThreeDayScore = 31.2; // 16 * 0.65 * 3
                StressLevel = (int)Math.Clamp((totalThreeDayScore / maxThreeDayScore) * 100, 0, 100);

                // Health Threshold: 7hrs avg/day over 3 days (21 total) = 100% recovery
                double targetHealthHours = 21;
                HealthLevel = (int)Math.Clamp((totalExerciseHours / targetHealthHours) * 100, 0, 100);
            }
        }
    }

    // Simplest way to get dynamic color
    private string GetStatusColor(int level, bool isStress)
    {
        if (isStress)
        {
            if (level <= 30) return "#2e8b57"; // Green
            if (level <= 50) return "#daa520"; // Gold
            if (level <= 80) return "#ff8c00"; // Orange
            return "#b03060"; // Red
        }
        else
        {
            {
                if (level <= 10) return "#FF0000"; // Red
                if (level <= 30) return "#FFA500"; // Orange
                if (level <= 50) return "#FFFF00"; // Yellow
                if (level <= 70) return "#90EE90"; // LightGreen
                return "#006400"; // DarkGreen
            }
        }
    }

    private string GetStressStatus(int level) => level switch
    {
        <= 30 => "Comfort",
        <= 50 => "Stretch",
        <= 80 => "Overly Stressed",
        _ => "Burnout"
    };

    private string GetHealthStatus(int level) => level switch
    {
        <= 10 => "Poor",
        <= 30 => "Try More",
        <= 50 => "Standard",
        <= 70 => "Active",
        _ => "Excellent"
    };

    void Save() => isEditing = false;
    double NeedleAngle(int val) => (val * 1.8) - 90;
}