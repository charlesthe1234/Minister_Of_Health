@page "/calendarevents/inbox"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer
@attribute [Authorize]

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-inbox"></i> My Inbox</h3>
        <a href="/calendarevents" class="btn btn-outline-secondary btn-sm">Back to Calendar</a>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (allMessages.Count == 0 && string.IsNullOrEmpty(successMessage))
    {
        <div class="text-center py-5 border rounded bg-light">
            <i class="bi bi-mailbox2 text-muted" style="font-size: 3rem;"></i>
            <p class="mt-3 text-muted">Your inbox is empty. No messages or invitations.</p>
        </div>
    }

    @* --- PENDING INVITES --- *@
    @foreach (var p in pendingInvites)
    {
        var duration = p.CalendarEvent != null ? p.CalendarEvent.EndDateTime - p.CalendarEvent.StartDateTime : TimeSpan.Zero;

        <div class="card mb-3 p-3 shadow-sm border-start border-primary border-4">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="mb-1 text-primary"><i class="bi bi-envelope-fill me-2"></i>@p.CalendarEvent?.EventName</h5>
                <span class="badge bg-info text-dark">@p.EventRole?.RoleName</span>
            </div>

            <div class="mb-3">
                <p class="text-muted small mb-2">
                    <i class="bi bi-person-fill me-1"></i>
                    <strong>Organized by:</strong> @(p.CalendarEvent?.HostUser?.UserName ?? "Unknown")
                </p>
                <p class="text-muted small mb-2">
                    <i class="bi bi-clock me-1"></i>
                    <strong>When:</strong> @p.CalendarEvent?.StartDateTime.ToString("dddd, MMMM dd, yyyy") at @p.CalendarEvent?.StartDateTime.ToString("h:mm tt") - @p.CalendarEvent?.EndDateTime.ToString("h:mm tt")
                </p>
                <p class="text-muted small mb-2">
                    <i class="bi bi-hourglass-split me-1"></i>
                    <strong>Duration:</strong> @(duration.TotalHours >= 1 ? $"{(int)duration.TotalHours}h {duration.Minutes}m" : $"{duration.Minutes}m")
                </p>
                @if (!string.IsNullOrEmpty(p.CalendarEvent?.Location))
                {
                    <p class="text-muted small mb-2">
                        <i class="bi bi-geo-alt-fill me-1"></i>
                        <strong>Location:</strong> @p.CalendarEvent.Location
                    </p>
                }
                @if (!string.IsNullOrEmpty(p.CalendarEvent?.Description))
                {
                    <div class="description-box p-2 bg-light rounded small text-dark mt-2">
                        <strong>Description:</strong> @p.CalendarEvent.Description
                    </div>
                }
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-success flex-grow-1" @onclick='() => Respond(p, "Accepted")'>
                    <i class="bi bi-check-circle me-1"></i> Accept
                </button>
                <button class="btn btn-outline-danger flex-grow-1" @onclick='() => Respond(p, "Rejected")'>
                    <i class="bi bi-x-circle me-1"></i> Reject
                </button>
            </div>
        </div>
    }

    @* --- UPDATE NOTIFICATIONS --- *@
    @foreach (var n in updateNotifications)
    {
        <div class="card mb-3 p-3 shadow-sm border-start border-warning border-4 bg-light">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="mb-1 text-dark">
                    <i class="bi bi-info-circle-fill text-warning me-2"></i>@n.CustomActivity
                </h5>
                <button class="btn-close" @onclick="() => DismissNotification(n.Id)"></button>
            </div>
            <p class="text-muted small mb-3">The event details have been changed. Click below to view the updated event.</p>
            <div class="d-flex gap-2">
                <button class="btn btn-primary flex-grow-1" @onclick='() => ViewEventDetails(n.CalendarEventId)'>
                    <i class="bi bi-calendar-event me-1"></i> View Event Details
                </button>
                <button class="btn btn-outline-secondary" @onclick="() => DismissNotification(n.Id)">
                    Dismiss
                </button>
            </div>
        </div>
    }

    @* --- REMOVAL NOTIFICATIONS --- *@
    @foreach (var n in removalNotifications)
    {
        <div class="card mb-3 p-3 shadow-sm border-start border-danger border-4 bg-light">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="mb-1 text-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>@n.CustomActivity
                </h5>
                <button class="btn-close" @onclick="() => DismissNotification(n.Id)"></button>
            </div>
            <p class="text-muted small mb-3">You have been removed from this event by the host.</p>
            <button class="btn btn-outline-secondary" @onclick="() => DismissNotification(n.Id)">
                <i class="bi bi-check me-1"></i> Acknowledge
            </button>
        </div>
    }

    @* --- DELETION NOTIFICATIONS --- *@
    @foreach (var n in deletionNotifications)
    {
        <div class="card mb-3 p-3 shadow-sm border-start border-secondary border-4 bg-light">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="mb-1 text-secondary">
                    <i class="bi bi-trash-fill me-2"></i>@n.CustomActivity
                </h5>
                <button class="btn-close" @onclick="() => DismissNotification(n.Id)"></button>
            </div>
            <p class="text-muted small mb-3">This event has been cancelled by the host.</p>
            <button class="btn btn-outline-secondary" @onclick="() => DismissNotification(n.Id)">
                <i class="bi bi-check me-1"></i> Acknowledge
            </button>
        </div>
    }
</div>

@code {
    private List<EventParticipant> pendingInvites = new();
    private List<EventParticipant> updateNotifications = new();
    private List<EventParticipant> removalNotifications = new();
    private List<EventParticipant> deletionNotifications = new();
    private List<EventParticipant> allMessages = new();
    private string? successMessage;
    private string? currentUserId;

    protected override async Task OnInitializedAsync() => await LoadInbox();

    private async Task LoadInbox()
    {
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(ClaimTypes.Email)?.Value;
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(email) && !string.IsNullOrEmpty(currentUserId))
        {
            // Get all messages for this user
            allMessages = await context.EventParticipant
                .Include(p => p.CalendarEvent)
                    .ThenInclude(e => e.HostUser)
                .Include(p => p.EventRole)
                .Where(p => (p.InviteeEmail.ToLower() == email.ToLower() || p.UserId == currentUserId) &&
                           (p.ParticipationStatus == "Pending" ||
                            p.ParticipationStatus == "UpdateNotification" ||
                            p.ParticipationStatus == "RemovedNotification" ||
                            p.ParticipationStatus == "DeleteNotification"))
                .OrderByDescending(p => p.Id)
                .ToListAsync();

            pendingInvites = allMessages.Where(p => p.ParticipationStatus == "Pending").ToList();
            updateNotifications = allMessages.Where(p => p.ParticipationStatus == "UpdateNotification").ToList();
            removalNotifications = allMessages.Where(p => p.ParticipationStatus == "RemovedNotification").ToList();
            deletionNotifications = allMessages.Where(p => p.ParticipationStatus == "DeleteNotification").ToList();
        }
    }

    private async Task Respond(EventParticipant p, string status)
    {
        using var context = DbFactory.CreateDbContext();

        if (!string.IsNullOrEmpty(currentUserId))
        {
            var dbParticipant = await context.EventParticipant.FindAsync(p.Id);
            if (dbParticipant != null)
            {
                dbParticipant.ParticipationStatus = status;
                dbParticipant.UserId = currentUserId;

                await context.SaveChangesAsync();
                successMessage = $"You have {status.ToLower()} the invite for {p.CalendarEvent?.EventName}.";
                await LoadInbox();
            }
        }
    }

    private async Task DismissNotification(int notificationId)
    {
        using var context = DbFactory.CreateDbContext();
        var notification = await context.EventParticipant.FindAsync(notificationId);

        if (notification != null)
        {
            context.EventParticipant.Remove(notification);
            await context.SaveChangesAsync();
            await LoadInbox();
        }
    }

    private void ViewEventDetails(int eventId)
    {
        NavigationManager.NavigateTo($"/calendarevents?eventId={eventId}");
    }
}