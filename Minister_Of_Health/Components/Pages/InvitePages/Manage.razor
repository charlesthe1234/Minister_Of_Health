@page "/calendarevents/manage-invites/{EventId:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Minister_Of_Time.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDbContextFactory<Minister_Of_Time.Data.Minister_Of_TimeContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]
@rendermode InteractiveServer

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/calendarevents">Calendar</a></li>
            <li class="breadcrumb-item active">Manage Invites</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Manage Invites</h2>
            <p class="text-muted">Event: <span class="text-primary fw-bold">@eventName</span></p>
        </div>
        <button class="btn btn-primary shadow-sm" @onclick="() => showAddGuestPopup = true">
            <i class="bi bi-person-plus-fill me-2"></i>Add New Guests
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading participants...</p>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success shadow-sm alert-dismissible fade show">
                <i class="bi bi-check-circle-fill me-2"></i> @successMessage
                <button type="button" class="btn-close" @onclick='() => successMessage = ""'></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-warning shadow-sm alert-dismissible fade show">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
                <button type="button" class="btn-close" @onclick='() => errorMessage = ""'></button>
            </div>
        }

        @* --- SECTION: REGISTERED USERS --- *@
        <h5 class="mb-3 text-primary"><i class="bi bi-person-check-fill me-2"></i>Registered Users (@knownParticipants.Count)</h5>
        <div class="row mb-5">
            @foreach (var p in knownParticipants)
            {
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm border-0 border-top border-primary border-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-bold text-truncate w-75" title="@p.InviteeEmail">@p.InviteeEmail</div>
                                <span class="badge @GetRoleClass(p.EventRole?.RoleName)">@p.EventRole?.RoleName</span>
                            </div>
                            <div class="mb-3">
                                <span class="badge rounded-pill @GetStatusClass(p.ParticipationStatus)">@p.ParticipationStatus</span>
                            </div>
                            <div class="d-grid gap-2 pt-2 border-top">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenManagePopup(p)">
                                    <i class="bi bi-gear me-1"></i> Change Permissions
                                </button>
                                @if (p.ParticipationStatus == "Pending")
                                {
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary flex-grow-1" @onclick="() => ReInvite(p)">
                                            <i class="bi bi-arrow-repeat me-1"></i> Resend
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger flex-grow-1" @onclick="() => ShowCancelInviteConfirmation(p)">
                                            <i class="bi bi-x-circle me-1"></i> Cancel
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ShowRemoveConfirmation(p)">
                                        <i class="bi bi-person-dash me-1"></i> Remove Participant
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* --- SECTION: PENDING REGISTRATIONS --- *@
        <h5 class="mb-3 text-secondary"><i class="bi bi-envelope-exclamation-fill me-2"></i>Pending Registrations (@unknownParticipants.Count)</h5>
        <div class="row mb-5">
            @foreach (var p in unknownParticipants)
            {
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm border-0 border-top border-secondary border-4 bg-light" style="border-style: dashed !important;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="text-muted text-truncate w-75">@p.InviteeEmail</div>
                                <span class="badge bg-secondary">@p.EventRole?.RoleName</span>
                            </div>
                            <div class="mb-3">
                                <span class="badge bg-warning text-dark">Awaiting Signup</span>
                            </div>
                            <div class="d-grid gap-2 pt-2 border-top">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenManagePopup(p)">
                                    <i class="bi bi-gear me-1"></i> Change Permissions
                                </button>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-grow-1" @onclick="() => ReInvite(p)">
                                        <i class="bi bi-arrow-repeat me-1"></i> Resend
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-grow-1" @onclick="() => ShowCancelInviteConfirmation(p)">
                                        <i class="bi bi-x-circle me-1"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* --- SECTION: HISTORY --- *@
        @if (historyParticipants.Any())
        {
            <hr class="my-5" />
            <h5 class="text-muted mb-3"><i class="bi bi-clock-history me-2"></i>Previous Participants</h5>
            <div class="table-responsive border rounded bg-white shadow-sm p-3">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Email</th>
                            <th>Former Role</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in historyParticipants)
                        {
                            <tr>
                                <td class="text-muted">@p.InviteeEmail</td>
                                <td><span class="badge bg-light text-dark border">@p.EventRole?.RoleName</span></td>
                                <td><span class="badge @GetStatusClass(p.ParticipationStatus)">@p.ParticipationStatus</span></td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ReInvite(p)">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i> Re-Invite
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
</div>

@* --- POPUP: ADD GUESTS (BATCH) --- *@
@if (showAddGuestPopup)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-people-fill me-2"></i>Invite Multiple Guests</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseAddGuestPopup"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Enter Email Addresses</label>
                        <div class="mb-2 p-2 border rounded bg-light" style="min-height: 60px; max-height: 200px; overflow-y: auto;">
                            @if (!batchInviteStatusList.Any())
                            {
                                <span class="text-muted small fst-italic">Enter emails separated by commas...</span>
                            }
                            @foreach (var status in batchInviteStatusList)
                            {
                                @if (status.IsDuplicate)
                                {
                                    <span class="badge bg-danger me-1 mb-1" title="Already invited or host email">
                                        @status.Email <i class="bi bi-exclamation-triangle-fill"></i>
                                    </span>
                                }
                                else if (!status.IsValidRole)
                                {
                                    <span class="badge bg-danger me-1 mb-1" title="Invalid Role - Only 'Editor' or 'Viewer' allowed">
                                        @status.Email (@status.RoleName) <i class="bi bi-x-circle-fill"></i>
                                    </span>
                                }
                                else
                                {
                                    <span class="badge @(status.IsRegistered ? "bg-success" : "bg-warning text-dark") me-1 mb-1">
                                        @status.Email (@status.RoleName) @(status.IsRegistered ? "✓" : "?")
                                    </span>
                                }
                            }
                        </div>
                        <textarea class="form-control" rows="4" @bind="batchGuestEmails" @oninput="OnBatchInviteInputChanged"
                                  placeholder="user1@email.com (Editor), user2@email.com, user3@email.com (Viewer)"></textarea>
                        <small class="text-muted">Separate multiple emails with commas. Valid roles: <strong>Editor</strong> or <strong>Viewer</strong> (default).</small>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button class="btn btn-link text-decoration-none text-muted" @onclick="CloseAddGuestPopup">Cancel</button>
                    <button class="btn btn-primary px-4" @onclick="AddBatchGuests" disabled="@(batchInviteStatusList.Any(x => x.IsDuplicate || !x.IsValidRole))">
                        <i class="bi bi-send me-1"></i> Send Invitations (@batchInviteStatusList.Count(x => !x.IsDuplicate && x.IsValidRole))
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* --- POPUP: MANAGE PERMISSIONS --- *@
@if (showManagePopup)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Change Permissions</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showManagePopup = false"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="mb-3">Change role for <strong>@selectedParticipant?.InviteeEmail</strong></p>
                    <select class="form-select form-select-lg mb-3" @bind="tempRoleId">
                        @foreach (var role in availableRoles)
                        {
                            <option value="@role.Value">@role.Key</option>
                        }
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="() => showManagePopup = false">Cancel</button>
                    <button class="btn btn-success" @onclick="UpdateRole">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
}

@* --- POPUP: CANCEL INVITE --- *@
@if (showCancelInvitePopup)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body text-center py-4">
                    <i class="bi bi-x-circle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Cancel Invitation?</h5>
                    <p class="text-muted small">This will remove the pending invitation.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-light border" @onclick="() => showCancelInvitePopup = false">No</button>
                        <button class="btn btn-warning" @onclick="ConfirmCancelInvite">Yes, Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* --- POPUP: REMOVE PARTICIPANT --- *@
@if (showRemovePopup)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body text-center py-4">
                    <i class="bi bi-person-dash text-danger" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Remove Participant?</h5>
                    <p class="text-muted small">They will receive a notification that they have been removed from this event.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-light border" @onclick="() => showRemovePopup = false">Cancel</button>
                        <button class="btn btn-danger" @onclick="ConfirmRemove">Remove</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int EventId { get; set; }
    private string eventName = "";
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private string currentUserId = "";
    private string currentUserEmail = "";

    private List<EventParticipant> knownParticipants = new();
    private List<EventParticipant> unknownParticipants = new();
    private List<EventParticipant> historyParticipants = new();
    private Dictionary<string, int> availableRoles = new();

    private bool showAddGuestPopup = false;
    private bool showManagePopup = false;
    private bool showRemovePopup = false;
    private bool showCancelInvitePopup = false;

    private EventParticipant? selectedParticipant;
    private int tempRoleId;

    // Batch invite fields
    private string batchGuestEmails = "";
    private List<BatchInviteStatus> batchInviteStatusList = new();

    private class BatchInviteStatus
    {
        public string Email { get; set; } = "";
        public string RoleName { get; set; } = "Viewer";
        public bool IsRegistered { get; set; }
        public bool IsDuplicate { get; set; }
        public bool IsValidRole { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
        currentUserEmail = authState.User.FindFirst(ClaimTypes.Email)?.Value ?? "";

        var ev = await context.CalendarEvent.FindAsync(EventId);
        if (ev == null)
        {
            NavigationManager.NavigateTo("/calendarevents");
            return;
        }

        eventName = ev.EventName;

        availableRoles = await context.EventRole
            .Where(r => r.RoleName == "Editor" || r.RoleName == "Viewer")
            .ToDictionaryAsync(r => r.RoleName, r => r.Id);

        await LoadParticipants();
    }

    private async Task LoadParticipants()
    {
        isLoading = true;
        using var context = DbFactory.CreateDbContext();
        var all = await context.EventParticipant
            .Include(p => p.EventRole)
            .Where(p => p.CalendarEventId == EventId)
            .ToListAsync();

        knownParticipants = all.Where(p => p.UserId != null && p.ParticipationStatus != "Left" && p.ParticipationStatus != "Rejected" && p.ParticipationStatus != "Removed").ToList();
        unknownParticipants = all.Where(p => p.UserId == null && p.ParticipationStatus != "Left" && p.ParticipationStatus != "Rejected" && p.ParticipationStatus != "Removed").ToList();
        historyParticipants = all.Where(p => p.ParticipationStatus == "Left" || p.ParticipationStatus == "Rejected" || p.ParticipationStatus == "Removed").ToList();

        isLoading = false;
        StateHasChanged();
    }

    private async Task OnBatchInviteInputChanged(ChangeEventArgs e)
    {
        batchGuestEmails = e.Value?.ToString() ?? "";
        var parsed = ParseBatchInvites(batchGuestEmails);
        var newList = new List<BatchInviteStatus>();
        var seen = new HashSet<string>();

        using var context = DbFactory.CreateDbContext();

        // Get all existing participants for this event
        var existingEmails = await context.EventParticipant
            .Where(p => p.CalendarEventId == EventId && p.ParticipationStatus != "Left" && p.ParticipationStatus != "Rejected" && p.ParticipationStatus != "Removed")
            .Select(p => p.InviteeEmail.ToLower())
            .ToListAsync();

        foreach (var item in parsed)
        {
            var emailLower = item.Email.ToLower();
            bool isHost = emailLower == currentUserEmail.ToLower();
            bool alreadyInvited = existingEmails.Contains(emailLower);
            bool duplicate = !seen.Add(emailLower) || isHost || alreadyInvited;

            var normalizedRole = item.RoleName.Trim();
            bool isValidRole = normalizedRole.Equals("Editor", StringComparison.OrdinalIgnoreCase) ||
                              normalizedRole.Equals("Viewer", StringComparison.OrdinalIgnoreCase);

            var exists = await context.Users.AnyAsync(u => u.Email.ToLower() == emailLower);

            newList.Add(new BatchInviteStatus
            {
                Email = item.Email,
                RoleName = normalizedRole,
                IsRegistered = exists,
                IsDuplicate = duplicate,
                IsValidRole = isValidRole
            });
        }
        batchInviteStatusList = newList;
        StateHasChanged();
    }

    private List<(string Email, string RoleName)> ParseBatchInvites(string input)
    {
        var list = new List<(string, string)>();
        if (string.IsNullOrWhiteSpace(input)) return list;

        foreach (var p in input.Split(','))
        {
            var trimmed = p.Trim();
            var match = System.Text.RegularExpressions.Regex.Match(trimmed, @"^([^(\s]+)(?:\s*\((.+?)\))?$");
            if (match.Success)
            {
                var email = match.Groups[1].Value.Trim();
                var role = match.Groups[2].Success ? match.Groups[2].Value.Trim() : "Viewer";
                list.Add((email, role));
            }
            else if (!string.IsNullOrEmpty(trimmed))
            {
                list.Add((trimmed, "Viewer"));
            }
        }
        return list;
    }

    private async Task AddBatchGuests()
    {
        var validInvites = batchInviteStatusList.Where(x => !x.IsDuplicate && x.IsValidRole).ToList();
        if (!validInvites.Any()) return;

        using var context = DbFactory.CreateDbContext();

        foreach (var invite in validInvites)
        {
            var emailLower = invite.Email.ToLower();
            var regUser = await context.Users.FirstOrDefaultAsync(u => u.Email.ToLower() == emailLower);
            var roleId = invite.RoleName.Equals("Editor", StringComparison.OrdinalIgnoreCase) ?
                availableRoles["Editor"] : availableRoles["Viewer"];

            context.EventParticipant.Add(new EventParticipant
            {
                CalendarEventId = EventId,
                InviteeEmail = invite.Email,
                UserId = regUser?.Id,
                EventRoleId = roleId,
                ParticipationStatus = "Pending"
            });
        }

        await context.SaveChangesAsync();
        successMessage = $"Successfully sent {validInvites.Count} invitation(s).";
        CloseAddGuestPopup();
        await LoadParticipants();
    }

    private void CloseAddGuestPopup()
    {
        showAddGuestPopup = false;
        batchGuestEmails = "";
        batchInviteStatusList.Clear();
    }

    private void OpenManagePopup(EventParticipant p)
    {
        selectedParticipant = p;
        tempRoleId = p.EventRoleId;
        showManagePopup = true;
    }

    private async Task UpdateRole()
    {
        if (selectedParticipant != null)
        {
            using var context = DbFactory.CreateDbContext();
            var record = await context.EventParticipant.FindAsync(selectedParticipant.Id);
            if (record != null)
            {
                record.EventRoleId = tempRoleId;
                await context.SaveChangesAsync();
                successMessage = $"Updated permissions for {selectedParticipant.InviteeEmail}.";
            }
            showManagePopup = false;
            await LoadParticipants();
        }
    }

    private async Task ReInvite(EventParticipant p)
    {
        using var context = DbFactory.CreateDbContext();
        var record = await context.EventParticipant.FindAsync(p.Id);
        if (record != null)
        {
            record.ParticipationStatus = "Pending";
            await context.SaveChangesAsync();
            successMessage = $"Re-invited {p.InviteeEmail}.";
            await LoadParticipants();
        }
    }

    private void ShowCancelInviteConfirmation(EventParticipant p)
    {
        selectedParticipant = p;
        showCancelInvitePopup = true;
    }

    private async Task ConfirmCancelInvite()
    {
        if (selectedParticipant != null)
        {
            using var context = DbFactory.CreateDbContext();
            var record = await context.EventParticipant.FindAsync(selectedParticipant.Id);
            if (record != null)
            {
                context.EventParticipant.Remove(record);
                await context.SaveChangesAsync();
                successMessage = $"Cancelled invitation for {selectedParticipant.InviteeEmail}.";
            }
            showCancelInvitePopup = false;
            await LoadParticipants();
        }
    }

    private void ShowRemoveConfirmation(EventParticipant p)
    {
        selectedParticipant = p;
        showRemovePopup = true;
    }

    private async Task ConfirmRemove()
    {
        if (selectedParticipant != null && selectedParticipant.UserId != null)
        {
            using var context = DbFactory.CreateDbContext();
            var record = await context.EventParticipant.FindAsync(selectedParticipant.Id);
            if (record != null)
            {
                // Change status to "Removed" and create notification
                record.ParticipationStatus = "Removed";

                // Create notification in inbox
                var notification = new EventParticipant
                {
                    CalendarEventId = EventId,
                    UserId = selectedParticipant.UserId,
                    InviteeEmail = selectedParticipant.InviteeEmail,
                    EventRoleId = selectedParticipant.EventRoleId,
                    ParticipationStatus = "RemovedNotification",
                    CustomActivity = $"You have been removed from the event: {eventName}"
                };
                context.EventParticipant.Add(notification);

                await context.SaveChangesAsync();
                successMessage = $"Removed {selectedParticipant.InviteeEmail} from the event.";
            }
            showRemovePopup = false;
            await LoadParticipants();
        }
    }

    private string GetStatusClass(string? status) => status switch
    {
        "Accepted" => "bg-success text-white",
        "Rejected" => "bg-danger text-white",
        "Left" => "bg-dark text-white",
        "Removed" => "bg-secondary text-white",
        _ => "bg-warning text-dark"
    };

    private string GetRoleClass(string? roleName) => roleName switch
    {
        "Editor" => "bg-primary text-white",
        "Viewer" => "bg-secondary text-white",
        _ => "bg-light text-dark"
    };
}